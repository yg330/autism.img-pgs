---
title: "pgs_img_ABCD_v3"
author: "Yuanjun Gu"
date: "4/12/2023"
output: html_document
---
# Setup
```{r markdown and packages setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse) # General code writing
library(here) # For reproducibility, remember open new project at the pgs_img folder
library(jtools) # For automation of summarizing lm models
library(huxtable, include.only = 'huxreg') # dependency of export_summ() in jtools package
library(Hmisc, include.only = 'rcorr') # For correlation matrix generation
library(corrplot) # For correlation matrix plot
library(data.table, include.only = "fread") # For fast data read-in
library(ggseg) # For brain plot
library(ggsegGlasser) # For Glasser segmentation specifically, note: ggsegGlasser is not avaliable for this version of R[4.3.0], but I've downloaded through ggseg r-universe frollowing their github recommendation.
library(car, include.only = 'vif') # for checking colinearity
library(patchwork) # For adding plots together
library(ggpubr)
```

```{r Phenotype Data Read-in and Clean up, echo=FALSE}
# Note: Age = months, age is 0/1 coded, age_squared = age*age, age_sex was done by age*sex column directly, how age_sexsquared is generated unknown
# No T1T2 status, No batch ID

Covar <- read.csv(here("QCd_pheno_covar/ABCD/ABCD_allcovariates.txt"), header = T, sep = "\t") # row 10584 - 10589 is NA
Covar <- drop_na(Covar) # Assume it is normal and delete these rows
Covar$site_id_l <- gsub("site","", Covar$site_id_l) # delete 'site' to make site number a numeric column
Covar$site_id_l <- as.numeric(Covar$site_id_l) # change value class as numeric

Pheno <- read.csv(here("QCd_pheno_covar/ABCD/ABCD_corticalpheno.txt"), header = T, sep = " ")  # Miss 20 people in comparison to 10583 in the Covar
ABCD <- full_join(Covar, Pheno, by = c("FID", "IID")) # merge data that are shared between two datasets
ABCD <- drop_na(ABCD) # Eliminated all NAs, for more info on why use colSums(is.na(ABCD))

gPCA <- fread(here("QCd_pheno_covar/ABCD/ABCD_PCsforGWAS_European.txt"))
gPCA <- rename(gPCA, IID = Sample_name) # Change name for merging
gPCA <- gPCA[,c(1:11)] # Only leave lm model relevant amount of PCAs
Covar <- full_join(Covar, gPCA, by = "IID") # merge data that are shared between two datasets

ABCD <- full_join(Covar, Pheno, by = c("FID", "IID")) # merge data that are shared between two datasets
ABCD <- ABCD[, c(1:5, 8:22, 28:29, 32:33)] # leave only relevant phenotypes, ABCD don't have T1T2 status

ABCD$Sex_Cat <-ifelse(ABCD$gender==1, "female", NA) # create new column Sex_Cat for easy grouping in plot with consideration of NA
ABCD$Sex_Cat <-ifelse(ABCD$gender==0, "male", ABCD$Sex_Cat) 

ABCD <- rename(ABCD, Sex = gender) # Rename For better code translation from UKB to ABCD
ABCD <- rename(ABCD, Age = interview_age)

# Read-in scores, rename and reformat data set for merging with ABCD
PGS <- fread(here("PGS/ABCD/autism_unstratified_finalscore.profile"))
PGS$PGS <- scale(PGS$SCORE) # Scaled numbers
PGS <- PGS[,c(2, 7)]

fPGS <- fread(here("PGS/ABCD/autism_females_finalscore.profile"))
fPGS$fPGS <- scale(fPGS$SCORE) # Scaled numbers
fPGS <- fPGS[,c(2, 7)]

mPGS <- fread(here("PGS/ABCD/autism_males_finalscore.profile"))
mPGS$mPGS <- scale(mPGS$SCORE) # Scaled numbers
mPGS <- mPGS[,c(2, 7)]

# Merge PGS, fPGS and mPGS score to ABCD
ABCD <- list(ABCD, PGS, fPGS, mPGS) %>% reduce(left_join, by= c("IID"))
ABCD <- drop_na(ABCD)

summary(ABCD$Age/12) # Summary of Age By Month thus we can get summary for age in years before being scaled

# Scale All variables
ABCD[c(3:24)] <- scale(ABCD[c(3:24)])

remove(Covar, Pheno, gPCA, fPGS, mPGS, PGS) # Remove dataset
```

```{r Sex Stratification and Scalling of phenotypes, include=FALSE}
# sex stratification
f_ABCD <- ABCD[ABCD$Sex_Cat == "female", ] # Female seems to be coded as 1, opposite from UKB
m_ABCD <- ABCD[ABCD$Sex_Cat == "male", ]

# Pheno and Continuous Covar Scaled by Sex (female)
f_ABCD[c(3:24, 26:28)] <- scale(f_ABCD[c(3:24, 26:28)]) # This will render scaled_sex number to be NaN, but as we will not use sex in later analyses or function, it is fine.
m_ABCD[c(3:24, 26:28)] <- scale(m_ABCD[c(3:24, 26:28)])
```

# Diagnosis and assumption checks
```{r Cohort Description Report}
# Sex Summary
table(ABCD$Sex_Cat)

```

```{r Q-Q plot for Normality Testing on MRI-derived phenotypes}
par(mfrow = c(2, 2))
qqnorm(ABCD$SA, pch = 1, frame = FALSE, ylim = c(-6, 8), main = "Q-Q Plot for Surface Area")
qqline(ABCD$SA, col = "steelblue", lwd = 2)
qqnorm(ABCD$CT, pch = 1, frame = FALSE, ylim = c(-6, 8), main = "Q-Q Plot for Cortical Thickness")
qqline(ABCD$CT, col = "steelblue", lwd = 2)
qqnorm(ABCD$meanCurv, pch = 1, frame = FALSE, ylim = c(-6, 8), main = "Q-Q Plot for Mean Curvature")
qqline(ABCD$CT, col = "steelblue", lwd = 2)
qqnorm(ABCD$NODDI_ICVF, pch = 1, frame = FALSE, ylim = c(-6, 8), main = "Q-Q Plot for Intracellular Volume Fraction")
qqline(ABCD$CT, col = "steelblue", lwd = 2)
```


```{r diagnosis graph and general tests for ABCD}
# F-test
var.test(SA ~ Sex_Cat, data = ABCD)
var.test(CT ~ Sex_Cat, data = ABCD)
var.test(meanCurv ~ Sex_Cat, data = ABCD)
var.test(NODDI_ICVF ~ Sex_Cat, data = ABCD)

# t-test
# In R, t-test default assumes unequal variance so no need for additional arguments
t.test(SA ~ Sex_Cat, data = ABCD)
t.test(CT ~ Sex_Cat, data = ABCD)
t.test(meanCurv ~ Sex_Cat, data = ABCD)
t.test(NODDI_ICVF ~ Sex_Cat, data = ABCD)

# Density plot
denSA <- ggdensity(ABCD, x = "SA",add = "mean", rug = TRUE, color = "Sex_Cat", fill = "Sex_Cat", palette = c("#FF9999", "#00AFBB")) + xlim(-5,5) + ylim(0.0, 0.6) + 
  labs(fill = "Sex", color = "Sex", x = "Surface Area in SD", caption = "F-test ***; t-test ***")

denCT <- ggdensity(ABCD, x = "CT",add = "mean", rug = TRUE, color = "Sex_Cat", fill = "Sex_Cat", palette = c("#FF9999", "#00AFBB")) + xlim(-5,5) + ylim(0.0, 0.6) + 
  labs(fill = "Sex", color = "Sex", x = "Cortical Thickness in SD", caption = "F-test Not.Sig, t-test ***")


denMC <- ggdensity(ABCD, x = "meanCurv",add = "mean", rug = TRUE, color = "Sex_Cat", fill = "Sex_Cat", palette = c("#FF9999", "#00AFBB")) + xlim(-5,5) + ylim(0.0, 0.6) + 
  labs(fill = "Sex", color = "Sex", x = "Mean Curvature in SD", caption = "F-test ***, t-test Not.Sig")


denICVF <- ggdensity(ABCD, x = "NODDI_ICVF",add = "mean", rug = TRUE, color = "Sex_Cat", fill = "Sex_Cat", palette = c("#FF9999", "#00AFBB")) + xlim(-5,5) + ylim(0.0, 0.6) + 
  labs(fill = "Sex", color = "Sex", x = "Intracellular Volume Fraction in SD", caption = "F-test Not.Sig., t-test ***")


denALL <- denSA + denCT + denMC + denICVF
denALL

# citation for the group: * < 0.05, ** < 0.01, *** < 0.001
```



# Global Correlation Analysis
```{r Correlation Matrix for PGS}
# For between PGS
pgs.rcorr = rcorr(as.matrix(ABCD[, c(26:28)])) # P = 0, what does it mean?
corrplot(pgs.rcorr$r, method = "color", type="upper", order="hclust", addCoef.col = "black", tl.col="black", tl.srt=45, 
         p.mat = pgs.rcorr$P, sig.level = 0.05)

# For IMG Phenotypes
ABCD.cor <- ABCD
ABCD.cor <- rename(ABCD.cor, "MC" = "meanCurv", "ICVF" = "NODDI_ICVF")
img.rcorr <- rcorr(as.matrix(ABCD.cor[, c(20:23)])) # For un-stratified population

f_ABCD.cor <- f_ABCD
f_ABCD.cor <- rename(f_ABCD.cor, "MC" = "meanCurv", "ICVF" = "NODDI_ICVF")
f.img.rcorr <- rcorr(as.matrix(f_ABCD.cor[, c(20:23)])) # For female population

m_ABCD.cor <- m_ABCD
m_ABCD.cor <- rename(m_ABCD.cor, "MC" = "meanCurv", "ICVF" = "NODDI_ICVF")
m.img.rcorr <- rcorr(as.matrix(m_ABCD.cor[, c(20:23)])) # For male population

img.rcorr$P[is.na(img.rcorr$P)] <- 0
f.img.rcorr$P[is.na(f.img.rcorr$P)] <- 0
m.img.rcorr$P[is.na(m.img.rcorr$P)] <- 0

corrplot(img.rcorr$r, method="color", type="upper", order="alphabet", title = "Unstratified IMG Correlation", 
         addCoef.col = "black", tl.col="black", tl.srt=45, p.mat = f.img.rcorr$P, sig.level = 0.05, mar=c(0,0,2,0))
corrplot(f.img.rcorr$r, method="color", type="upper", order="alphabet", title = "Female IMG Correlation", 
         addCoef.col = "black", tl.col="black", tl.srt=45, p.mat = f.img.rcorr$P, sig.level = 0.05, mar=c(0,0,2,0))
corrplot(m.img.rcorr$r, method="color", type="upper", order="alphabet", title = "Male IMG Correlation", 
         addCoef.col = "black", tl.col="black", tl.srt=45, p.mat = m.img.rcorr$P, sig.level = 0.05, mar=c(0,0,2,0))
# Graph improvement idea for reordering: rstatix::corr_reorder()
```

# Study of Global phenotype effect through Linear fixed effect models and summary
```{r Lm for IMG~PGS to study the Impact of PGS on brain structure}

PGS.Str_SA <- lm(SA ~ PGS + Sex + Age + Age_squared + Sex * Age + Sex * Age_squared + X1 + X2 + X3 + X4 + X5 + X6 + X7 + X8 + X9 + X10 + site_id_l + leftplusright + fd_1, data = ABCD)
PGS.Str_CT <- lm(CT ~ PGS + Sex + Age + Age_squared + Sex * Age + Sex * Age_squared + X1 + X2 + X3 + X4 + X5 + X6 + X7 + X8 + X9 + X10 + site_id_l + leftplusright + fd_1, data = ABCD)
PGS.Str_MC <- lm(meanCurv ~ PGS + Sex + Age + Age_squared + Sex * Age + Sex * Age_squared + X1 + X2 + X3 + X4 + X5 + X6 + X7 + X8 + X9 + X10 + site_id_l + leftplusright + fd_1, data = ABCD)
PGS.ICVF <- lm(NODDI_ICVF ~ PGS + Sex + Age + Age_squared + Sex * Age + Sex * Age_squared + X1 + X2 + X3 + X4 + X5 + X6 + X7 + X8 + X9 + X10 + site_id_l + leftplusright + fd_1, data = ABCD)

summary(PGS.Str_SA)
summary(PGS.Str_CT)
summary(PGS.Str_MC)
summary(PGS.ICVF)
```

```{r Lm for IMG~PGS + PGS:SEX to study the Impact of Sex:PGS on brain structure}
PGS.sex.Str_SA <- lm(SA ~ PGS + Sex + Age + Age_squared + Sex * Age + Sex * Age_squared + PGS * Sex + X1 + X2 + X3 + X4 + X5 + X6 + X7 + X8 + X9 + X10 + site_id_l + leftplusright + fd_1, data = ABCD)
PGS.sex.Str_CT <- lm(CT ~ PGS + Sex + Age + Age_squared + Sex * Age + Sex * Age_squared + PGS * Sex + X1 + X2 + X3 + X4 + X5 + X6 + X7 + X8 + X9 + X10 + site_id_l + leftplusright + fd_1, data = ABCD)
PGS.sex.Str_MC <- lm(meanCurv ~ PGS + Sex + Age + Age_squared + Sex * Age + Sex * Age_squared + PGS * Sex + X1 + X2 + X3 + X4 + X5 + X6 + X7 + X8 + X9 + X10 + site_id_l + leftplusright + fd_1, data = ABCD)
PGS.sex.ICVF <- lm(NODDI_ICVF ~ PGS + Sex + Age + Age_squared + Sex * Age + Sex * Age_squared + PGS * Sex + X1 + X2 + X3 + X4 + X5 + X6 + X7 + X8 + X9 + X10 + site_id_l + leftplusright + fd_1, data = ABCD)

summary(PGS.sex.Str_SA)
summary(PGS.sex.Str_CT)
summary(PGS.sex.Str_MC)
summary(PGS.sex.ICVF)

```

```{r summary result for all IMG~PGS models, results = 'asis'}
# For SA
export_summs(PGS.Str_SA, PGS.sex.Str_SA,
             model.names = c("SA~PGS", "SA~PGS + Sex Interaction"),
             coefs = c("(Intercept)", "Sex", "Age", "Age^2" = "Age_squared", "Sex:Age", "Sex:Age^2" = "Sex:Age_squared", 
                       "PGS", "PGS:Sex" = "PGS:Sex"))

# For CT
export_summs(PGS.Str_CT, PGS.sex.Str_CT, 
             model.names = c("CT~PGS", "CT~PGS + Sex Interaction"), 
             coefs = c("(Intercept)", "Sex", "Age", "Age^2" = "Age_squared", "Sex:Age", "Sex:Age^2" = "Sex:Age_squared", 
                       "PGS", "PGS:Sex" = "PGS:Sex"))

# For MC
export_summs(PGS.Str_MC, PGS.sex.Str_MC, 
             model.names = c("MC~PGS", "MC~PGS + Sex Interaction"), 
             coefs = c("(Intercept)", "Sex", "Age", "Age^2" = "Age_squared", "Sex:Age", "Sex:Age^2" = "Sex:Age_squared", 
                       "PGS", "PGS:Sex" = "PGS:Sex"))

# For ICVF
export_summs(PGS.ICVF, PGS.sex.ICVF, 
             model.names = c("ICVF~PGS", "ICVF~PGS + Sex Interaction"), 
             coefs = c("(Intercept)", "Sex", "Age", "Age^2" = "Age_squared", "Sex:Age", "Sex:Age^2" = "Sex:Age_squared", 
                       "PGS", "PGS:Sex" = "PGS:Sex"))
```


# Study of Sex Difference between male and female population through Linear fixed effect models and summary
```{r Global lm for IMG~fPGS/mPGS in female and male only population to study the Sex-specific Impact of fPGS/mPGS on brain structure}
# For female
fPGS.Str_SA <- lm(SA ~ fPGS + Age + Age_squared + X1 + X2 + X3 + X4 + X5 + X6 + X7 + X8 + X9 + X10 + site_id_l + leftplusright + fd_1, data = f_ABCD)
fPGS.Str_CT <- lm(CT ~ fPGS + Age + Age_squared + X1 + X2 + X3 + X4 + X5 + X6 + X7 + X8 + X9 + X10 + site_id_l + leftplusright + fd_1, data = f_ABCD)
fPGS.Str_MC <- lm(meanCurv ~ fPGS + Age + Age_squared + X1 + X2 + X3 + X4 + X5 + X6 + X7 + X8 + X9 + X10 + site_id_l + leftplusright + fd_1, data = f_ABCD)
fPGS.ICVF <- lm(NODDI_ICVF ~ fPGS + Age + Age_squared + X1 + X2 + X3 + X4 + X5 + X6 + X7 + X8 + X9 + X10 + site_id_l + leftplusright + fd_1, data = f_ABCD)

summary(fPGS.Str_SA)
summary(fPGS.Str_CT)
summary(fPGS.Str_MC)
summary(fPGS.ICVF)

# For Male
mPGS.Str_SA <- lm(SA ~ mPGS + Age + Age_squared + X1 + X2 + X3 + X4 + X5 + X6 + X7 + X8 + X9 + X10 + site_id_l + leftplusright + fd_1, data = m_ABCD)
mPGS.Str_CT <- lm(CT ~ mPGS + Age + Age_squared + X1 + X2 + X3 + X4 + X5 + X6 + X7 + X8 + X9 + X10 + site_id_l + leftplusright + fd_1, data = m_ABCD)
mPGS.Str_MC <- lm(meanCurv ~ mPGS + Age + Age_squared + X1 + X2 + X3 + X4 + X5 + X6 + X7 + X8 + X9 + X10 + site_id_l + leftplusright + fd_1, data = m_ABCD)
mPGS.ICVF <- lm(NODDI_ICVF ~ mPGS + Age + Age_squared + X1 + X2 + X3 + X4 + X5 + X6 + X7 + X8 + X9 + X10 + site_id_l + leftplusright + fd_1, data = m_ABCD)

summary(mPGS.Str_SA)
summary(mPGS.Str_CT)
summary(mPGS.Str_MC)
summary(mPGS.ICVF)
```

```{r summary result for all IMG~PGS models + sex stratification, results = 'asis'}
# For SA
export_summs(PGS.Str_SA, PGS.sex.Str_SA, fPGS.Str_SA, mPGS.Str_SA,
             model.names = c("SA~PGS", "SA~PGS + Sex Interaction", "fSA~fPGS", "mSA~mPGS"),
             coefs = c("(Intercept)", "Sex", "Age", "Age^2" = "Age_squared", "Sex:Age", "Sex:Age^2" = "Sex:Age_squared", 
                       "PGS", "fPGS", "mPGS", "PGS:Sex" = "PGS:Sex"))

# For CT
export_summs(PGS.Str_CT, PGS.sex.Str_CT, fPGS.Str_CT, mPGS.Str_CT,
             model.names = c("CT~PGS", "CT~PGS + Sex Interaction", "fCT~fPGS", "mCT~mPGS"), 
             coefs = c("(Intercept)", "Sex", "Age", "Age^2" = "Age_squared", "Sex:Age", "Sex:Age^2" = "Sex:Age_squared", 
                       "PGS", "fPGS", "mPGS", "PGS:Sex" = "PGS:Sex"))

# For MC
export_summs(PGS.Str_MC, PGS.sex.Str_MC,  fPGS.Str_MC, mPGS.Str_MC,
             model.names = c("MC~PGS", "MC~PGS + Sex Interaction", "fMC~fPGS", "mMC~mPGS"), 
             coefs = c("(Intercept)", "Sex", "Age", "Age^2" = "Age_squared", "Sex:Age", "Sex:Age^2" = "Sex:Age_squared", 
                       "PGS", "fPGS", "mPGS", "PGS:Sex" = "PGS:Sex"))

# For ICVF
export_summs(PGS.ICVF, PGS.sex.ICVF,  fPGS.ICVF, mPGS.ICVF,
             model.names = c("ICVF~PGS", "ICVF~PGS + Sex Interaction", "fICVF~fPGS", "mICVF~mPGS"), 
             coefs = c("(Intercept)", "Sex", "Age", "Age^2" = "Age_squared", "Sex:Age", "Sex:Age^2" = "Sex:Age_squared", 
                       "PGS", "fPGS", "mPGS", "PGS:Sex" = "PGS:Sex"))

```

# Data Visualisation of PGS, fPGS in female, mPGS in male and PGS:SEX effect using summary result plot, Inc.R2 plot and prediction effect plot

```{r create lm for IMG~Covar for unstratified, female and male population}
# For Unstratified Population

Str_SA <- lm(SA ~ Sex + Age + Age_squared + Sex * Age + Sex * Age_squared + X1 + X2 + X3 + X4 + X5 + X6 + X7 + X8 + X9 + X10 + site_id_l + leftplusright + fd_1, data = ABCD)

Str_CT <- lm(CT ~ Sex + Age + Age_squared + Sex * Age + Sex * Age_squared + X1 + X2 + X3 + X4 + X5 + X6 + X7 + X8 + X9 + X10 + site_id_l + leftplusright + fd_1, data = ABCD)

Str_MC <- lm(meanCurv ~ Sex + Age + Age_squared + Sex * Age + Sex * Age_squared + X1 + X2 + X3 + X4 + X5 + X6 + X7 + X8 + X9 + X10 + site_id_l + leftplusright + fd_1, data = ABCD)

ICVF <- lm(NODDI_ICVF ~ Sex + Age + Age_squared + Sex * Age + Sex * Age_squared + X1 + X2 + X3 + X4 + X5 + X6 + X7 + X8 + X9 + X10 + site_id_l + leftplusright + fd_1, data = ABCD)

# For female population
fStr_SA <- lm(SA ~ Age + Age_squared + X1 + X2 + X3 + X4 + X5 + X6 + X7 + X8 + X9 + X10 + site_id_l + leftplusright + fd_1, data = f_ABCD)

fStr_CT <- lm(CT ~ Age + Age_squared + X1 + X2 + X3 + X4 + X5 + X6 + X7 + X8 + X9 + X10 + site_id_l + leftplusright + fd_1, data = f_ABCD)

fStr_MC <- lm(meanCurv ~ Age + Age_squared + X1 + X2 + X3 + X4 + X5 + X6 + X7 + X8 + X9 + X10 + site_id_l + leftplusright + fd_1, data = f_ABCD)

fICVF <- lm(NODDI_ICVF ~ Age + Age_squared + X1 + X2 + X3 + X4 + X5 + X6 + X7 + X8 + X9 + X10 + site_id_l + leftplusright + fd_1, data = f_ABCD)

# For male population
mStr_SA <- lm(SA ~ Age + Age_squared + X1 + X2 + X3 + X4 + X5 + X6 + X7 + X8 + X9 + X10 + site_id_l + leftplusright + fd_1, data = m_ABCD)

mStr_CT <- lm(CT ~ Age + Age_squared + X1 + X2 + X3 + X4 + X5 + X6 + X7 + X8 + X9 + X10 + site_id_l + leftplusright + fd_1, data = m_ABCD)

mStr_MC <- lm(meanCurv ~ Age + Age_squared + X1 + X2 + X3 + X4 + X5 + X6 + X7 + X8 + X9 + X10 + site_id_l + leftplusright + fd_1, data = m_ABCD)

mICVF <- lm(NODDI_ICVF ~ Age + Age_squared + X1 + X2 + X3 + X4 + X5 + X6 + X7 + X8 + X9 + X10 + site_id_l + leftplusright + fd_1, data = m_ABCD)
```

```{r summary result for IMG~PGS vs IMG~Covar in unstratified, female and male population, results = 'asis'}

# For SA
export_summs(PGS.Str_SA, PGS.sex.Str_SA, fPGS.Str_SA, mPGS.Str_SA, Str_SA, fStr_SA, mStr_SA,
             model.names = c("SA~PGS", "SA~PGS + Sex Interaction", "fSA~fPGS", "mSA~mPGS", "SA~Covar", "fSA~Covar", "mSA~Covar"),
             coefs = c("(Intercept)", "Sex", "Age", "Age^2" = "Age_squared", "Sex:Age", "Sex:Age^2" = "Sex:Age_squared", 
                       "PGS", "fPGS", "mPGS", "PGS:Sex" = "PGS:Sex"))

# For CT
export_summs(PGS.Str_CT, PGS.sex.Str_CT, fPGS.Str_CT, mPGS.Str_CT, Str_CT, fStr_CT, mStr_CT,
             model.names = c("CT~PGS", "CT~PGS + Sex Interaction", "fCT~fPGS", "mCT~mPGS", "CT~Covar", "fCT~Covar", "mCT~Covar"),
             coefs = c("(Intercept)", "Sex", "Age", "Age^2" = "Age_squared", "Sex:Age", "Sex:Age^2" = "Sex:Age_squared", 
                       "PGS", "fPGS", "mPGS", "PGS:Sex" = "PGS:Sex"))
# For MC
export_summs(PGS.Str_MC, PGS.sex.Str_MC, fPGS.Str_MC, mPGS.Str_MC, Str_MC, fStr_MC, mStr_MC,
             model.names = c("MC~PGS", "MC~PGS + Sex Interaction", "fMC~fPGS", "mMC~mPGS", "MC~Covar", "fMC~Covar", "mMC~Covar"),
             coefs = c("(Intercept)", "Sex", "Age", "Age^2" = "Age_squared", "Sex:Age", "Sex:Age^2" = "Sex:Age_squared", 
                       "PGS", "fPGS", "mPGS", "PGS:Sex" = "PGS:Sex"))
# For ICVF
export_summs(PGS.ICVF, PGS.sex.ICVF, fPGS.ICVF, mPGS.ICVF, ICVF, fICVF, mICVF,
             model.names = c("ICVF~PGS", "ICVF~PGS + Sex Interaction", "fICVF~fPGS", "mICVF~mPGS", "ICVF~Covar", "fICVF~Covar", "mICVF~Covar"),
             coefs = c("(Intercept)", "Sex", "Age", "Age^2" = "Age_squared", "Sex:Age", "Sex:Age^2" = "Sex:Age_squared", 
                       "PGS", "fPGS", "mPGS", "PGS:Sex" = "PGS:Sex"))

```

```{r Inc.R2 for PGS and PGS:SEX}
# Inc.R2 filling loop for PGS, fPGS and mPGS: IMG~PGS/fPGS/mPGS - IMG~COVAR

inc.R2 <- data.frame (IMG  = c(rep("SA", 3), rep("CT", 3), rep("MC", 3), rep("ICVF", 3)), R2 = NA, Label = rep(1:3, 4), Population = rep(1:3,4)) # Create Empty R2 dataframe

inc.R2 <- inc.R2 %>% mutate(Label = case_when(
  Label == 1 ~ "PGS",
  Label == 2 ~ "fPGS",
  Label == 3 ~ "mPGS"
  ))

inc.R2 <- inc.R2 %>% mutate(Population = case_when(
  Population == 1 ~ "Unstratified",
  Population == 2 ~ "Female",
  Population == 3 ~ "Male"
  ))

data_files = list("PGS.Str_SA" = PGS.Str_SA, "fPGS.Str_SA" = fPGS.Str_SA, "mPGS.Str_SA" = mPGS.Str_SA, 
                  "PGS.Str_CT" = PGS.Str_CT, "fPGS.Str_CT" = fPGS.Str_CT, "mPGS.Str_CT" = mPGS.Str_CT, 
                  "PGS.Str_MC" = PGS.Str_MC, "fPGS.Str_MC" = fPGS.Str_MC, "mPGS.Str_MC" = mPGS.Str_MC, 
                  "PGS.ICVF" = PGS.ICVF, "fPGS.ICVF" = fPGS.ICVF, "mPGS.ICVF" = mPGS.ICVF,
                  "Str_SA" = Str_SA, "fStr_SA" = fStr_SA, "mStr_SA" = mStr_SA, 
                  "Str_CT" = Str_CT, "fStr_CT" = fStr_CT, "mStr_CT" = mStr_CT, 
                  "Str_MC" = Str_MC, "fStr_MC" = fStr_MC, "mStr_MC" = mStr_MC, 
                  "ICVF" = ICVF, "fICVF" = fICVF, "mICVF" = mICVF) # list relevant files and assign names for looping

for (i in 1:12) {
  print(paste("Working on:", names(data_files[i]), "and", names(data_files[i+12])))
  inc.R2[i, 2] <- summary(data_files[[i]])$adj.r.squared - summary(data_files[[i+12]])$adj.r.squared
}


# In.R2 filling loop for for PGS:SEX: IMG~PGS:SEX-IMG~PGS (for completion sake, not significant)
inc.R2.sex.interaction <- data.frame (IMG  = c("SA", "CT","MC", "ICVF"), R2 = NA, Label = "PGS:Sex", Population = "unstratified") # Create Empty R2 dataframe

data_files = list("PGS.sex.Str_SA" = PGS.sex.Str_SA, "PGS.sex.Str_CT" = PGS.sex.Str_CT, "PGS.sex.Str_MC" = PGS.sex.Str_MC, "PGS.sex.ICVF" = PGS.sex.ICVF,
                  "PGS.Str_SA" = PGS.Str_SA, "PGS.Str_CT" = PGS.Str_CT, "PGS.Str_MC" = PGS.Str_MC, "PGS.ICVF" = PGS.ICVF) # list relevant files and assign names for looping

for (i in 1:4) {
  print(paste("Working on:", names(data_files[i]), "and", names(data_files[i+4])))
  inc.R2.sex.interaction[i, 2] <- summary(data_files[[i]])$adj.r.squared - summary(data_files[[i+4]])$adj.r.squared
}

inc.R2
inc.R2.sex.interaction

```

```{r Inc.R2 Visualisation for Global Phenotypes}
inc.R2$Association <- c(rep("positive", 2), rep("negative", 2), "positive", rep("negative", 7)) # insert color after checking coefficient summary for lm
inc.R2$sig <- c(rep(NA, 9),"*", NA, "*") # same as above, insert sig annotation

# For PGS/fPGS/mPGS effect in unstratified, female and male population
inc.R2.fig <- ggplot(inc.R2, aes(y=R2, x= factor(IMG, levels = c("SA", "CT", "MC", "ICVF")), col = Association, fill = Association)) + 
  geom_bar(position="dodge", stat="identity") + facet_wrap(~Label) + scale_fill_manual(values=c("skyblue", "tomato")) + scale_color_manual(values=c("skyblue", "tomato")) + 
  labs(y = "Inc.R^2 for PGS/fPGS/mPGS", x = "IMG Phenotypes") + 
  ggtitle("Inc.R2 for PGS, fPGS and mPGS in sex stratified and unstratified ABCD population") + geom_text(aes(label = sig), col = "black", vjust = -0.25) + ylim(-5e-04, 2e-03)
  
inc.R2.fig


#For PGS:Sex interaction effect in unstratified population
inc.R2.sex.interaction$Association <- c(rep("positive", 2), "negative", "positive") # insert color after checking coefficient summary for lm
# No sig PGS:SEX coefficient

inc.R2.sex.fig <- ggplot(inc.R2.sex.interaction, aes(y = R2, x = factor(IMG, levels = c("SA", "CT", "MC", "ICVF")), col = Association, fill = Association)) + 
  geom_bar(position="dodge", stat="identity") + ggtitle("Incremental R2 for unstratified ABCD population") + labs(x = "IMG Phenotypes", y = "Inc.R^2 for PGS:SEX") +
  scale_fill_manual(values=c("skyblue", "tomato")) + scale_color_manual(values=c("skyblue", "tomato")) + ylim(-5e-04, 2e-03)
inc.R2.sex.fig

```

```{r check multiple colinearity}
# VIF exceeding 5 or 10 indicates high multicollinearity between this independent variable and the others
# Age and Agesquared are highly colinear with each other is as expected. No fault found.

vif(PGS.Str_SA, type = "predictor")
vif(PGS.Str_CT, type = "predictor")
vif(PGS.Str_MC, type = "predictor")
vif(PGS.ICVF, type = "predictor")

vif(fPGS.Str_SA)
vif(fPGS.Str_CT)
vif(fPGS.Str_MC)
vif(fPGS.ICVF)

vif(mPGS.Str_SA)
vif(mPGS.Str_CT)
vif(mPGS.Str_MC)
vif(mPGS.ICVF)
```

```{r visualising linear regression}
# visualise linear regression
# Black = unstratified; #FF9999 = Female; #00AFBB = Male
# For SA
PGS.SA.lm.vis <- ggplot(PGS.Str_SA, aes(PGS, SA)) + geom_smooth(method = "lm", colour = "black", linewidth = 0.5) +
  stat_smooth(data = fPGS.Str_SA, inherit.aes = FALSE, aes(fPGS, SA), method = "lm", colour = "tomato", linewidth = 0.5) + 
  stat_smooth(data = mPGS.Str_SA, inherit.aes = FALSE, aes(mPGS, SA), method = "lm", colour = "#00AFBB", linewidth = 0.5) + xlim(-5,5) +
  labs(y = "Surface Area", x = "PGS/fPGS/mPGS in SD")

# For CT
PGS.CT.lm.vis <- ggplot(PGS.Str_CT, aes(PGS, CT)) + geom_smooth(method = "lm", colour = "black", linewidth = 0.5) +
  stat_smooth(data = fPGS.Str_CT, inherit.aes = FALSE, aes(fPGS, CT), method = "lm", colour = "tomato", linewidth = 0.5) + 
  stat_smooth(data = mPGS.Str_CT, inherit.aes = FALSE, aes(mPGS, CT), method = "lm", colour = "#00AFBB", linewidth = 0.5) + xlim(-5,5) +
  labs(y = "Cortical Thickness", x = "PGS/fPGS/mPGS in SD")

# For MC
PGS.MC.lm.vis <- ggplot(PGS.Str_MC, aes(PGS, meanCurv)) + geom_smooth(method = "lm", colour = "black", linewidth = 0.5) +
  stat_smooth(data = fPGS.Str_MC, inherit.aes = FALSE, aes(fPGS, meanCurv), method = "lm", colour = "tomato", linewidth = 0.5) + 
  stat_smooth(data = mPGS.Str_MC, inherit.aes = FALSE, aes(mPGS, meanCurv), method = "lm", colour = "#00AFBB", linewidth = 0.5) + xlim(-5,5) +
  labs(y = "Mean Curvature", x = "PGS/fPGS/mPGS in SD")

# For ICVF
PGS.ICVF.lm.vis <- ggplot(PGS.ICVF, aes(PGS, NODDI_ICVF)) + geom_smooth(method = "lm", colour = "black", linewidth = 0.5) +
  stat_smooth(data = fPGS.ICVF, inherit.aes = FALSE, aes(fPGS, NODDI_ICVF), method = "lm", colour = "tomato", linewidth = 0.5) + 
  stat_smooth(data = mPGS.ICVF, inherit.aes = FALSE, aes(mPGS, NODDI_ICVF), method = "lm", colour = "#00AFBB", linewidth = 0.5) + xlim(-5,5) +
  labs(y = "Intracellular Volume Fraction", x = "PGS/fPGS/mPGS in SD")

PGS.IMG.lm.ALL <- (PGS.SA.lm.vis | PGS.CT.lm.vis) / (PGS.MC.lm.vis| PGS.ICVF.lm.vis)
PGS.IMG.lm.ALL

```

```{r combinational effect plot (prediction plot) using jtool sourse code}
PGS.eff.SA <-  effect_plot(PGS.Str_SA, pred = PGS, interval = TRUE, colors ="Black") + xlim(-5,5) + ylim(-0.3,0.3) + labs(y = "Surface Area")
fPGS.eff.SA <- effect_plot(fPGS.Str_SA, pred = fPGS, interval = TRUE, colors ="tomato") + xlim(-5,5) + ylim(-0.3,0.3) + labs(y = "Surface Area")
mPGS.eff.SA <- effect_plot(mPGS.Str_SA, pred = mPGS, interval = TRUE, colors ="#00AFBB") + xlim(-5,5) + ylim(-0.3,0.3) + labs(y = "Surface Area")
effSA <- PGS.eff.SA + fPGS.eff.SA + mPGS.eff.SA
effSA

PGS.eff.CT <- effect_plot(PGS.Str_CT, pred = PGS, interval = TRUE) + xlim(-5,5) + ylim(-0.3,0.3) + labs(y = "Cortical Thickness")
fPGS.eff.CT <- effect_plot(fPGS.Str_CT, pred = fPGS, interval = TRUE, colors ="tomato") + xlim(-5,5) + ylim(-0.3,0.3) + labs(y = "Cortical Thickness")
mPGS.eff.CT <- effect_plot(mPGS.Str_CT, pred = mPGS, interval = TRUE, colors ="#00AFBB")+ xlim(-5,5) + ylim(-0.3,0.3) + labs(y = "Cortical Thickness")
effCT <- PGS.eff.CT + fPGS.eff.CT + mPGS.eff.CT
effCT

PGS.eff.MC <- effect_plot(PGS.Str_MC, pred = PGS, interval = TRUE) + xlim(-5,5) + ylim(-0.3,0.3) + labs(y = "Mean Curvature")
fPGS.eff.MC <- effect_plot(fPGS.Str_MC, pred = fPGS, interval = TRUE, colors ="tomato") + xlim(-5,5) + ylim(-0.3,0.3) + labs(y = "Mean Curvature")
mPGS.eff.MC <- effect_plot(mPGS.Str_MC, pred = mPGS, interval = TRUE, colors ="#00AFBB")+ xlim(-5,5) + ylim(-0.3,0.3) + labs(y = "Mean Curvature")
effMC <- PGS.eff.MC + fPGS.eff.MC + mPGS.eff.MC
effMC

PGS.eff.ICVF <- effect_plot(PGS.ICVF, pred = PGS, interval = TRUE) + xlim(-5,5) + ylim(-0.3,0.3) + labs(y = "Intracellular Volume Fraction")
fPGS.eff.ICVF <- effect_plot(fPGS.ICVF, pred = fPGS, interval = TRUE, colors ="tomato") + xlim(-5,5) + ylim(-0.3,0.3) + labs(y = "Intracellular Volume Fraction")
mPGS.eff.ICVF <- effect_plot(mPGS.ICVF, pred = mPGS, interval = TRUE, colors ="#00AFBB") + xlim(-5,5) + ylim(-0.3,0.3) + labs(y = "Intracellular Volume Fraction")
effICVF <- PGS.eff.ICVF + fPGS.eff.ICVF + mPGS.eff.ICVF
effICVF

# I've tried but effect_plot doesn't support plotting multiple graph together, and in order to change it I'll need deep understanding of his code and make it work.
# From the source code I've located his key function on using make_prediction() but I couldn't fully understand his ggplot2 code.
# It is suggested that uses make_prediction() restuls into the ggplot2 pipeline, need more time to think about how the code works.
```




# Study of Regional Phenotype effect through Linear fixed effect models and summary

```{r read-in raw regional effect tables and create IMG~Reg.PGS datasets, eval=FALSE, include=FALSE}
# Remove load-in object for memory
rm(list= ls()[!(ls() %in% c('ABCD','f_ABCD', "m_ABCD"))])

# Modify ABCD column name so it doesn't conflict with regional brain names, remove "FID" as it is the same with "IID"
ABCD <- ABCD %>% rename(gPC1 = 10, gPC2 = 11, gPC3 = 12, gPC4 = 13, gPC5 = 14, gPC6 = 15, gPC7 = 16, gPC8 = 17, gPC9 = 18, gPC10 = 19) #Rename X1:10 to gPC1:10
f_ABCD <- f_ABCD %>% rename(gPC1 = 10, gPC2 = 11, gPC3 = 12, gPC4 = 13, gPC5 = 14, gPC6 = 15, gPC7 = 16, gPC8 = 17, gPC9 = 18, gPC10 = 19)
m_ABCD <- m_ABCD %>% rename(gPC1 = 10, gPC2 = 11, gPC3 = 12, gPC4 = 13, gPC5 = 14, gPC6 = 15, gPC7 = 16, gPC8 = 17, gPC9 = 18, gPC10 = 19)

ABCD <- ABCD[2:28] # Remove FID
f_ABCD <- f_ABCD[2:28]
m_ABCD <- m_ABCD[2:28]

# Read in raw regional IMG data
Raw.SA <- read.csv(here("QCd_pheno_covar/ABCD/SA_regional.txt"), header = T, sep = " ")
Raw.CT <- read.csv(here("QCd_pheno_covar/ABCD/CT_regional.txt"), header = T, sep = " ")
Raw.MC <- read.csv(here("QCd_pheno_covar/ABCD/meancurv_regional.txt"), header = T, sep = " ")
Raw.ICVF <- read.csv(here("QCd_pheno_covar/ABCD/ICVF_regional.txt"), header = T, sep = " ")

# merge to ABCD group
reg.pgs.SA <- list(ABCD, Raw.SA)
reg.pgs.SA <- reg.pgs.SA %>% reduce(left_join, by= c("IID")) 
# merge data sets, remove row if IID (i.e. FID too) not present in ABCD

reg.pgs.CT <- list(ABCD, Raw.CT)
reg.pgs.CT <- reg.pgs.CT %>% reduce(left_join, by= c("IID")) # merge data sets

reg.pgs.MC <- list(ABCD, Raw.MC)
reg.pgs.MC <- reg.pgs.MC %>% reduce(left_join, by= c("IID")) # merge data sets

reg.pgs.ICVF <- list(ABCD, Raw.ICVF)
reg.pgs.ICVF <- reg.pgs.ICVF %>% reduce(left_join, by= c("IID")) # merge data sets

# merge to f_ABCD group

f.reg.pgs.SA <- list(f_ABCD, Raw.SA)
f.reg.pgs.SA <- f.reg.pgs.SA %>% reduce(left_join, by= c("IID")) 

f.reg.pgs.CT <- list(f_ABCD, Raw.CT)
f.reg.pgs.CT <- f.reg.pgs.CT %>% reduce(left_join, by= c("IID")) # merge data sets

f.reg.pgs.MC <- list(f_ABCD, Raw.MC)
f.reg.pgs.MC <- f.reg.pgs.MC %>% reduce(left_join, by= c("IID")) # merge data sets

f.reg.pgs.ICVF <- list(f_ABCD, Raw.ICVF)
f.reg.pgs.ICVF <- f.reg.pgs.ICVF %>% reduce(left_join, by= c("IID")) # merge data sets


# merge to m_ABCD group
m.reg.pgs.SA <- list(m_ABCD, Raw.SA)
m.reg.pgs.SA <- m.reg.pgs.SA %>% reduce(left_join, by= c("IID")) 
# merge data sets, remove row if IID and FID not present in ABCD

m.reg.pgs.CT <- list(m_ABCD, Raw.CT)
m.reg.pgs.CT <- m.reg.pgs.CT %>% reduce(left_join, by= c("IID")) # merge data sets

m.reg.pgs.MC <- list(m_ABCD, Raw.MC)
m.reg.pgs.MC <- m.reg.pgs.MC %>% reduce(left_join, by= c("IID")) # merge data sets

m.reg.pgs.ICVF <- list(m_ABCD, Raw.ICVF)
m.reg.pgs.ICVF <- m.reg.pgs.ICVF %>% reduce(left_join, by= c("IID")) # merge data sets

# removed unused variables
remove(Raw.SA, Raw.CT, Raw.MC, Raw.ICVF)

# Set-up for looping
data_files = list("reg.pgs.SA" = reg.pgs.SA, "reg.pgs.CT" = reg.pgs.CT, "reg.pgs.MC" = reg.pgs.MC, "reg.pgs.ICVF" = reg.pgs.ICVF, 
                  "f.reg.pgs.SA" = f.reg.pgs.SA, "f.reg.pgs.CT" = f.reg.pgs.CT, "f.reg.pgs.MC" = f.reg.pgs.MC, "f.reg.pgs.ICVF" = f.reg.pgs.ICVF, 
                  "m.reg.pgs.SA" = m.reg.pgs.SA, "m.reg.pgs.CT" = m.reg.pgs.CT, "m.reg.pgs.MC" = m.reg.pgs.MC, "m.reg.pgs.ICVF" = m.reg.pgs.ICVF) # list relevant files and assign names
n_regions = 180 # Act as j in loop, as Glasser parcellation has 180 regions after averaging left and right hemisphere

```

```{r lm model loop for Reg.IMG~PGS, eval=FALSE, include=FALSE}
# For Reg.IMG~PGS (Doesn't need to seperate macro and micro structure as no different set of covariate is needed)
for (i in 1:4) {
  beta_values = matrix(NA, nrow = n_regions)
  p_values = matrix(NA, nrow = n_regions)
  t_values = matrix(NA, nrow = n_regions)
  se_values = matrix(NA, nrow = n_regions)
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for (j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    PGS.model = lm(currentROI ~ PGS + Sex + Age + Age_squared + Sex * Age + Sex * Age_squared + gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                     site_id_l + leftplusright + fd_1, data = temp.data)
    coef = coefficients(summary(PGS.model))
    coef = coef[2,] # Stats around PGS Score
    beta_values[j,] = coef[1]
    se_values[j] = coef[2]
    t_values[j] = coef[3]
    p_values[j] = coef[4]
    region[j] = reg.list[j]
    r2_squared[j] = summary(PGS.model)$adj.r.squared
    df= data.frame(region, Beta_Estimates = beta_values, Std.Error = se_values, t_val = t_values, P_val = p_values, R2 = r2_squared)
    write.table(df, paste0("ABCD.", "PGS.", names(data_files[i]), "_v2.txt"), sep = "\t", row.names = F, col.names = T)
  }
}

```

```{r lm model loop for Reg.IMG~PGS + Glb.IMG, eval=FALSE, include=FALSE}

# For Reg.SA~PGS+Glb.SA (macro-structure)
for (i in 1) {
  beta_values = matrix(NA, nrow = n_regions)
  p_values = matrix(NA, nrow = n_regions)
  t_values = matrix(NA, nrow = n_regions)
  se_values = matrix(NA, nrow = n_regions)
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for (j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    PGS.model = lm(currentROI ~ PGS + SA + Sex + Age + Age_squared + Sex * Age + Sex * Age_squared + 
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    coef = coefficients(summary(PGS.model))
    coef = coef[2,] # Stats around PGS Score
    beta_values[j,] = coef[1]
    se_values[j] = coef[2]
    t_values[j] = coef[3]
    p_values[j] = coef[4]
    region[j] = reg.list[j]
    r2_squared[j] = summary(PGS.model)$adj.r.squared
    df= data.frame(region, Beta_Estimates = beta_values, Std.Error = se_values, t_val = t_values, P_val = p_values, R2 = r2_squared)
    write.table(df, paste0("ABCD.", "PGS.", names(data_files[i]), ".GlbSA_v2.txt"), sep = "\t", row.names = F, col.names = T)
  }
}


# For Reg.CT~PGS+Glb.CT (macro-structure)
for (i in 2) {
  beta_values = matrix(NA, nrow = n_regions)
  p_values = matrix(NA, nrow = n_regions)
  t_values = matrix(NA, nrow = n_regions)
  se_values = matrix(NA, nrow = n_regions)
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for (j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <-  colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    PGS.model = lm(currentROI ~ PGS + CT + Sex + Age + Age_squared + Sex * Age + Sex * Age_squared + 
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    coef = coefficients(summary(PGS.model))
    coef = coef[2,] # Stats around PGS Score
    beta_values[j,] = coef[1]
    se_values[j] = coef[2]
    t_values[j] = coef[3]
    p_values[j] = coef[4]
    region[j] = reg.list[j]
    r2_squared[j] = summary(PGS.model)$adj.r.squared
    df= data.frame(region, Beta_Estimates = beta_values, Std.Error = se_values, t_val = t_values, P_val = p_values, R2 = r2_squared)
    write.table(df, paste0("ABCD.", "PGS.", names(data_files[i]), ".GlbCT_v2.txt"), sep = "\t", row.names = F, col.names = T)
  }
}

# For Reg.MC~PGS+Glb.MC (macro-structure)
for (i in 3) {
  beta_values = matrix(NA, nrow = n_regions)
  p_values = matrix(NA, nrow = n_regions)
  t_values = matrix(NA, nrow = n_regions)
  se_values = matrix(NA, nrow = n_regions)
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for (j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    PGS.model = lm(currentROI ~ PGS + meanCurv + Sex + Age + Age_squared + Sex * Age + Sex * Age_squared + 
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    coef = coefficients(summary(PGS.model))
    coef = coef[2,] # Stats around PGS Score
    beta_values[j,] = coef[1]
    se_values[j] = coef[2]
    t_values[j] = coef[3]
    p_values[j] = coef[4]
    region[j] = reg.list[j]
    r2_squared[j] = summary(PGS.model)$adj.r.squared
    df= data.frame(region, Beta_Estimates = beta_values, Std.Error = se_values, t_val = t_values, P_val = p_values, R2 = r2_squared)
    write.table(df, paste0("ABCD.", "PGS.", names(data_files[i]), ".GlbMC_v2.txt"), sep = "\t", row.names = F, col.names = T)
  }
}

# For Reg.ICVF~PGS+Glb.ICVF (micro-structure)
for (i in 4) {
  beta_values = matrix(NA, nrow = n_regions)
  p_values = matrix(NA, nrow = n_regions)
  t_values = matrix(NA, nrow = n_regions)
  se_values = matrix(NA, nrow = n_regions)
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for (j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    PGS.model = lm(currentROI ~ PGS + NODDI_ICVF + Sex + Age + Age_squared + Sex * Age + Sex * Age_squared + 
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    coef = coefficients(summary(PGS.model))
    coef = coef[2,] # Stats around PGS Score
    beta_values[j,] = coef[1]
    se_values[j] = coef[2]
    t_values[j] = coef[3]
    p_values[j] = coef[4]
    region[j] = reg.list[j]
    r2_squared[j] = summary(PGS.model)$adj.r.squared
    df= data.frame(region, Beta_Estimates = beta_values, Std.Error = se_values, t_val = t_values, P_val = p_values, R2 = r2_squared)
    write.table(df, paste0("ABCD.", "PGS.", names(data_files[i]), ".GlbICVF_v2.txt"), sep = "\t", row.names = F, col.names = T)
  }
}

```

```{r lm model loop for f/m Reg.IMG ~ fPGS/mPGS + Glb.IMG, eval=FALSE, include=FALSE}
# For female populations 
# Reg.SA ~ fPGS + Glb.SA (macro-structure)
for (i in 5) {
  beta_values = matrix(NA, nrow = n_regions)
  p_values = matrix(NA, nrow = n_regions)
  t_values = matrix(NA, nrow = n_regions)
  se_values = matrix(NA, nrow = n_regions)
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for(j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    PGS.model = lm(currentROI ~ fPGS + Age + Age_squared + SA +
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    coef = coefficients(summary(PGS.model))
    coef = coef[2,] # Stats around PGS Score
    beta_values[j,] = coef[1]
    se_values[j] = coef[2]
    t_values[j] = coef[3]
    p_values[j] = coef[4]
    region[j] = reg.list[j]
    r2_squared[j] = summary(PGS.model)$adj.r.squared
    df= data.frame(region, Beta_Estimates = beta_values, Std.Error = se_values, t_val = t_values, P_val = p_values, R2 = r2_squared)
    write.table(df, paste0("ABCD.", "PGS.", names(data_files[i]), ".GlbSA_V2.txt"), sep = "\t", row.names = F, col.names = T)
  }
}

# Reg.CT ~ fPGS + Glb.CT (macro-structure)
for (i in 6) {
  beta_values = matrix(NA, nrow = n_regions)
  p_values = matrix(NA, nrow = n_regions)
  t_values = matrix(NA, nrow = n_regions)
  se_values = matrix(NA, nrow = n_regions)
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for(j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    PGS.model = lm(currentROI ~ fPGS + Age + Age_squared + CT +
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    coef = coefficients(summary(PGS.model))
    coef = coef[2,] # Stats around PGS Score
    beta_values[j,] = coef[1]
    se_values[j] = coef[2]
    t_values[j] = coef[3]
    p_values[j] = coef[4]
    region[j] = reg.list[j]
    r2_squared[j] = summary(PGS.model)$adj.r.squared
    df= data.frame(region, Beta_Estimates = beta_values, Std.Error = se_values, t_val = t_values, P_val = p_values, R2 = r2_squared)
    write.table(df, paste0("ABCD.", "PGS.", names(data_files[i]), ".GlbCT_v2.txt"), sep = "\t", row.names = F, col.names = T)
  }
}

# Reg.MC ~ fPGS + Glb.MC (macro-structure)
for (i in 7) {
  beta_values = matrix(NA, nrow = n_regions)
  p_values = matrix(NA, nrow = n_regions)
  t_values = matrix(NA, nrow = n_regions)
  se_values = matrix(NA, nrow = n_regions)
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for(j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    PGS.model = lm(currentROI ~ fPGS + Age + Age_squared + meanCurv +
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    coef = coefficients(summary(PGS.model))
    coef = coef[2,] # Stats around PGS Score
    beta_values[j,] = coef[1]
    se_values[j] = coef[2]
    t_values[j] = coef[3]
    p_values[j] = coef[4]
    region[j] = reg.list[j]
    r2_squared[j] = summary(PGS.model)$adj.r.squared
    df= data.frame(region, Beta_Estimates = beta_values, Std.Error = se_values, t_val = t_values, P_val = p_values, R2 = r2_squared)
    write.table(df, paste0("ABCD.", "PGS.", names(data_files[i]), ".GlbMC_v2.txt"), sep = "\t", row.names = F, col.names = T)
  }
}

# For Reg.ICVF~ fPGS + Glb.ICVF (micro-structure)
for (i in 8) {
  beta_values = matrix(NA, nrow = n_regions)
  p_values = matrix(NA, nrow = n_regions)
  t_values = matrix(NA, nrow = n_regions)
  se_values = matrix(NA, nrow = n_regions)
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for (j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    PGS.model = lm(currentROI ~ fPGS +  Age + Age_squared + NODDI_ICVF +
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    coef = coefficients(summary(PGS.model))
    coef = coef[2,] # Stats around PGS Score
    beta_values[j,] = coef[1]
    se_values[j] = coef[2]
    t_values[j] = coef[3]
    p_values[j] = coef[4]
    region[j] = reg.list[j]
    r2_squared[j] = summary(PGS.model)$adj.r.squared
    df= data.frame(region, Beta_Estimates = beta_values, Std.Error = se_values, t_val = t_values, P_val = p_values, R2 = r2_squared)
    write.table(df, paste0("ABCD.", "PGS.", names(data_files[i]), ".GlbICVF_v2.txt"), sep = "\t", row.names = F, col.names = T)
  }
}



# For male populations
# Reg.SA ~ mPGS + Glb.SA (macro-structure)
for (i in 9) {
  beta_values = matrix(NA, nrow = n_regions)
  p_values = matrix(NA, nrow = n_regions)
  t_values = matrix(NA, nrow = n_regions)
  se_values = matrix(NA, nrow = n_regions)
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for(j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    PGS.model = lm(currentROI ~ mPGS + Age + Age_squared + SA +
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    coef = coefficients(summary(PGS.model))
    coef = coef[2,] # Stats around PGS Score
    beta_values[j,] = coef[1]
    se_values[j] = coef[2]
    t_values[j] = coef[3]
    p_values[j] = coef[4]
    region[j] = reg.list[j]
    r2_squared[j] = summary(PGS.model)$adj.r.squared
    df= data.frame(region, Beta_Estimates = beta_values, Std.Error = se_values, t_val = t_values, P_val = p_values, R2 = r2_squared)
    write.table(df, paste0("ABCD.", "PGS.", names(data_files[i]), ".GlbSA_v2.txt"), sep = "\t", row.names = F, col.names = T)
  }
}

# Reg.CT ~ mPGS + Glb.CT (macro-structure)
for (i in 10) {
  beta_values = matrix(NA, nrow = n_regions)
  p_values = matrix(NA, nrow = n_regions)
  t_values = matrix(NA, nrow = n_regions)
  se_values = matrix(NA, nrow = n_regions)
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for(j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    PGS.model = lm(currentROI ~ mPGS + Age + Age_squared + CT +
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    coef = coefficients(summary(PGS.model))
    coef = coef[2,] # Stats around PGS Score
    beta_values[j,] = coef[1]
    se_values[j] = coef[2]
    t_values[j] = coef[3]
    p_values[j] = coef[4]
    region[j] = reg.list[j]
    r2_squared[j] = summary(PGS.model)$adj.r.squared
    df= data.frame(region, Beta_Estimates = beta_values, Std.Error = se_values, t_val = t_values, P_val = p_values, R2 = r2_squared)
    write.table(df, paste0("ABCD.", "PGS.", names(data_files[i]), ".GlbCT_v2.txt"), sep = "\t", row.names = F, col.names = T)
  }
}

# Reg.MC ~ mPGS + Glb.MC (macro-structure)
for (i in 11) {
  beta_values = matrix(NA, nrow = n_regions)
  p_values = matrix(NA, nrow = n_regions)
  t_values = matrix(NA, nrow = n_regions)
  se_values = matrix(NA, nrow = n_regions)
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for(j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    PGS.model = lm(currentROI ~ mPGS + Age + Age_squared + meanCurv +
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    coef = coefficients(summary(PGS.model))
    coef = coef[2,] # Stats around PGS Score
    beta_values[j,] = coef[1]
    se_values[j] = coef[2]
    t_values[j] = coef[3]
    p_values[j] = coef[4]
    region[j] = reg.list[j]
    r2_squared[j] = summary(PGS.model)$adj.r.squared
    df= data.frame(region, Beta_Estimates = beta_values, Std.Error = se_values, t_val = t_values, P_val = p_values, R2 = r2_squared)
    write.table(df, paste0("ABCD.", "PGS.", names(data_files[i]), ".GlbMC_v2.txt"), sep = "\t", row.names = F, col.names = T)
  }
}

# For Reg.ICVF~ mPGS + Glb.ICVF (micro-structure)
for (i in 12) {
  beta_values = matrix(NA, nrow = n_regions)
  p_values = matrix(NA, nrow = n_regions)
  t_values = matrix(NA, nrow = n_regions)
  se_values = matrix(NA, nrow = n_regions)
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for (j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    PGS.model = lm(currentROI ~ mPGS +  Age + Age_squared + NODDI_ICVF +
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    coef = coefficients(summary(PGS.model))
    coef = coef[2,] # Stats around PGS Score
    beta_values[j,] = coef[1]
    se_values[j] = coef[2]
    t_values[j] = coef[3]
    p_values[j] = coef[4]
    region[j] = reg.list[j]
    r2_squared[j] = summary(PGS.model)$adj.r.squared
    df= data.frame(region, Beta_Estimates = beta_values, Std.Error = se_values, t_val = t_values, P_val = p_values, R2 = r2_squared)
    write.table(df, paste0("ABCD.", "PGS.", names(data_files[i]), ".GlbICVF_v2.txt"), sep = "\t", row.names = F, col.names = T)
  }
}

```

```{r lm model loop for Reg.IMG~PGS + Sex:PGS + Glb.IMG, updated to include both PGS and PGS:SEX coefficients, eval=FALSE, include=FALSE}

# For Reg.SA~PGS + Sex:PGS + Glb.SA (macro-structure)
for (i in 1) {
  PGS.beta_values = matrix(NA, nrow = n_regions)
  PGS.SEX.beta_values = matrix(NA, nrow = n_regions)
  PGS.p_values = matrix(NA, nrow = n_regions)
  PGS.SEX.p_values = matrix(NA, nrow = n_regions)
  PGS.t_values = matrix(NA, nrow = n_regions)
  PGS.SEX.t_values = matrix(NA, nrow = n_regions)
  PGS.se_values = matrix(NA, nrow = n_regions)
  PGS.SEX.se_values = matrix(NA, nrow = n_regions)
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for (j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    PGS.model = lm(currentROI ~ PGS + PGS * Sex + SA + Sex + Age + Age_squared + Sex * Age + Sex * Age_squared +
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    coef = coefficients(summary(PGS.model))
    coef1 = coef[2,] # Stats around PGS
    PGS.beta_values[j,] = coef1[1]
    PGS.se_values[j,] = coef1[2]
    PGS.t_values[j,] = coef1[3]
    PGS.p_values[j,] = coef1[4]
    coef2 = coef[20,] # Stats around PGS:SEX
    PGS.SEX.beta_values[j,] = coef2[1]
    PGS.SEX.se_values[j] = coef2[2]
    PGS.SEX.t_values[j] = coef2[3]
    PGS.SEX.p_values[j] = coef2[4]
    region[j] = reg.list[j]
    r2_squared[j] = summary(PGS.model)$adj.r.squared
    df= data.frame(region, PGS_Beta_Estimates = PGS.beta_values, PGS_SEX_Beta_Estimates = PGS.SEX.beta_values, 
                   PGS_Std.Error = PGS.se_values, PGS_SEX_Std.Error = PGS.SEX.se_values, PGS_t_val = PGS.t_values, PGS_SEX_t_val = PGS.SEX.t_values, 
                   PGS_P_val = PGS.p_values, PGS_SEX_P_val = PGS.SEX.p_values, R2 = r2_squared)
    write.table(df, paste0("ABCD.", "PGS.", names(data_files[i]), ".GlbSA_v2_SEX.txt"), sep = "\t", row.names = F, col.names = T)
  }
}

# For Reg.CT~PGS + Sex:PGS + Glb.CT (macro-structure)
for (i in 2) {
  PGS.beta_values = matrix(NA, nrow = n_regions)
  PGS.SEX.beta_values = matrix(NA, nrow = n_regions)
  PGS.p_values = matrix(NA, nrow = n_regions)
  PGS.SEX.p_values = matrix(NA, nrow = n_regions)
  PGS.t_values = matrix(NA, nrow = n_regions)
  PGS.SEX.t_values = matrix(NA, nrow = n_regions)
  PGS.se_values = matrix(NA, nrow = n_regions)
  PGS.SEX.se_values = matrix(NA, nrow = n_regions)
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for (j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    PGS.model = lm(currentROI ~ PGS + PGS * Sex + CT + Sex + Age + Age_squared + Sex * Age + Sex * Age_squared +
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    coef = coefficients(summary(PGS.model))
    coef1 = coef[2,] # Stats around PGS
    PGS.beta_values[j,] = coef1[1]
    PGS.se_values[j,] = coef1[2]
    PGS.t_values[j,] = coef1[3]
    PGS.p_values[j,] = coef1[4]
    coef2 = coef[20,] # Stats around PGS:SEX
    PGS.SEX.beta_values[j,] = coef2[1]
    PGS.SEX.se_values[j] = coef2[2]
    PGS.SEX.t_values[j] = coef2[3]
    PGS.SEX.p_values[j] = coef2[4]
    region[j] = reg.list[j]
    r2_squared[j] = summary(PGS.model)$adj.r.squared
    df= data.frame(region, PGS_Beta_Estimates = PGS.beta_values, PGS_SEX_Beta_Estimates = PGS.SEX.beta_values, 
                   PGS_Std.Error = PGS.se_values, PGS_SEX_Std.Error = PGS.SEX.se_values, PGS_t_val = PGS.t_values, PGS_SEX_t_val = PGS.SEX.t_values, 
                   PGS_P_val = PGS.p_values, PGS_SEX_P_val = PGS.SEX.p_values, R2 = r2_squared)
    write.table(df, paste0("ABCD.", "PGS.", names(data_files[i]), ".GlbCT_v2_SEX.txt"), sep = "\t", row.names = F, col.names = T)
  }
}


# For Reg.MC~PGS + Sex:PGS + Glb.MC (macro-structure)
for (i in 3) {
  PGS.beta_values = matrix(NA, nrow = n_regions)
  PGS.SEX.beta_values = matrix(NA, nrow = n_regions)
  PGS.p_values = matrix(NA, nrow = n_regions)
  PGS.SEX.p_values = matrix(NA, nrow = n_regions)
  PGS.t_values = matrix(NA, nrow = n_regions)
  PGS.SEX.t_values = matrix(NA, nrow = n_regions)
  PGS.se_values = matrix(NA, nrow = n_regions)
  PGS.SEX.se_values = matrix(NA, nrow = n_regions)
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for (j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    PGS.model = lm(currentROI ~ PGS + PGS * Sex + meanCurv + Sex + Age + Age_squared + Sex * Age + Sex * Age_squared + 
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    coef = coefficients(summary(PGS.model))
    coef1 = coef[2,] # Stats around PGS
    PGS.beta_values[j,] = coef1[1]
    PGS.se_values[j,] = coef1[2]
    PGS.t_values[j,] = coef1[3]
    PGS.p_values[j,] = coef1[4]
    coef2 = coef[20,] # Stats around PGS:SEX
    PGS.SEX.beta_values[j,] = coef2[1]
    PGS.SEX.se_values[j] = coef2[2]
    PGS.SEX.t_values[j] = coef2[3]
    PGS.SEX.p_values[j] = coef2[4]
    region[j] = reg.list[j]
    r2_squared[j] = summary(PGS.model)$adj.r.squared
    df= data.frame(region, PGS_Beta_Estimates = PGS.beta_values, PGS_SEX_Beta_Estimates = PGS.SEX.beta_values, 
                   PGS_Std.Error = PGS.se_values, PGS_SEX_Std.Error = PGS.SEX.se_values, PGS_t_val = PGS.t_values, PGS_SEX_t_val = PGS.SEX.t_values, 
                   PGS_P_val = PGS.p_values, PGS_SEX_P_val = PGS.SEX.p_values, R2 = r2_squared)
    write.table(df, paste0("ABCD.", "PGS.", names(data_files[i]), ".GlbMC_v2_SEX.txt"), sep = "\t", row.names = F, col.names = T)
  }
}

# For Reg.IMG~PGS + Sex:PGS + Glb.ICVF (micro-structure)
for (i in 4) {
  PGS.beta_values = matrix(NA, nrow = n_regions)
  PGS.SEX.beta_values = matrix(NA, nrow = n_regions)
  PGS.p_values = matrix(NA, nrow = n_regions)
  PGS.SEX.p_values = matrix(NA, nrow = n_regions)
  PGS.t_values = matrix(NA, nrow = n_regions)
  PGS.SEX.t_values = matrix(NA, nrow = n_regions)
  PGS.se_values = matrix(NA, nrow = n_regions)
  PGS.SEX.se_values = matrix(NA, nrow = n_regions)
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for (j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    PGS.model = lm(currentROI ~ PGS + PGS * Sex + NODDI_ICVF + Sex + Age + Age_squared + Sex * Age + Sex * Age_squared +
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    coef = coefficients(summary(PGS.model))
    coef1 = coef[2,] # Stats around PGS
    PGS.beta_values[j,] = coef1[1]
    PGS.se_values[j,] = coef1[2]
    PGS.t_values[j,] = coef1[3]
    PGS.p_values[j,] = coef1[4]
    coef2 = coef[20,] # Stats around PGS:SEX, number doesn't need to change like UKB as number of covariates are the same between microstructure and macrostructure phenotypes
    PGS.SEX.beta_values[j,] = coef2[1]
    PGS.SEX.se_values[j] = coef2[2]
    PGS.SEX.t_values[j] = coef2[3]
    PGS.SEX.p_values[j] = coef2[4]
    region[j] = reg.list[j]
    r2_squared[j] = summary(PGS.model)$adj.r.squared
    df= data.frame(region, PGS_Beta_Estimates = PGS.beta_values, PGS_SEX_Beta_Estimates = PGS.SEX.beta_values, 
                   PGS_Std.Error = PGS.se_values, PGS_SEX_Std.Error = PGS.SEX.se_values, PGS_t_val = PGS.t_values, PGS_SEX_t_val = PGS.SEX.t_values, 
                   PGS_P_val = PGS.p_values, PGS_SEX_P_val = PGS.SEX.p_values, R2 = r2_squared)
    write.table(df, paste0("ABCD.", "PGS.", names(data_files[i]), ".GlbICVF_v2_SEX.txt"), sep = "\t", row.names = F, col.names = T)
  }
}

```

# Regional Inc.R2 model loop
```{r lm model loop for Reg.IMG~COVAR for Inc.R2 calculation, eval=FALSE, include=FALSE}

# For Reg.IMG~PGS
for (i in 1:4) {
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for (j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    IMG.model = lm(currentROI ~ Sex + Age + Age_squared + Sex * Age + Sex * Age_squared + 
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    region[j] = reg.list[j]
    r2_squared[j] = summary(IMG.model)$adj.r.squared
    df= data.frame(region, R2 = r2_squared)
    write.table(df, paste0("ABCD.", names(data_files[i]), "_v2.txt"), sep = "\t", row.names = F, col.names = T)
  }
}

```

```{r lm model loop for Reg.IMG~Glb.IMG+COVAR for Inc.R2 calculation, eval=FALSE, include=FALSE}

# For Reg.SA~Glb.SA+COVAR (macro-structure)
for (i in 1) {
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for (j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    IMG.model = lm(currentROI ~ SA + Sex + Age + Age_squared + Sex * Age + Sex * Age_squared + 
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    region[j] = reg.list[j]
    r2_squared[j] = summary(IMG.model)$adj.r.squared
    df= data.frame(region, R2 = r2_squared)
    write.table(df, paste0("ABCD.", names(data_files[i]), ".GlbSA.txt"), sep = "\t", row.names = F, col.names = T)
  }
}


# For Reg.CT~Glb.CT+COVAR (macro-structure)
for (i in 2) {
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for (j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    IMG.model = lm(currentROI ~ CT + Sex + Age + Age_squared + Sex * Age + Sex * Age_squared + 
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    region[j] = reg.list[j]
    r2_squared[j] = summary(IMG.model)$adj.r.squared
    df= data.frame(region, R2 = r2_squared)
    write.table(df, paste0("ABCD.", names(data_files[i]), ".GlbCT.txt"), sep = "\t", row.names = F, col.names = T)
  }
}


# For Reg.MC~Glb.MC+COVAR (macro-structure)
for (i in 3) {
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for (j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    IMG.model = lm(currentROI ~ meanCurv + Sex + Age + Age_squared + Sex * Age + Sex * Age_squared + 
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    region[j] = reg.list[j]
    r2_squared[j] = summary(IMG.model)$adj.r.squared
    df= data.frame(region, R2 = r2_squared)
    write.table(df, paste0("ABCD", names(data_files[i]), ".GlbMC.txt"), sep = "\t", row.names = F, col.names = T)
  }
}

# For Reg.ICVF~PGS+Glb.ICVF (micro-structure)
for (i in 4) {
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for (j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    IMG.model = lm(currentROI ~ NODDI_ICVF + Sex + Age + Age_squared + Sex * Age + Sex * Age_squared + 
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    region[j] = reg.list[j]
    r2_squared[j] = summary(IMG.model)$adj.r.squared
    df= data.frame(region, R2 = r2_squared)
    write.table(df, paste0("ABCD.", names(data_files[i]), ".GlbICVF.txt"), sep = "\t", row.names = F, col.names = T)
  }
}

```

```{r lm model loop for f/m Reg.IMG ~ f/m Glb.IMG+COVAR for Inc.R2 calculation, eval=FALSE, include=FALSE}
# For female populations 
# Reg.SA ~ fPGS + Glb.SA (macro-structure)
for (i in 5) {
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for(j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    IMG.model = lm(currentROI ~ Age + Age_squared + SA +
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    region[j] = reg.list[j]
    r2_squared[j] = summary(IMG.model)$adj.r.squared
    df= data.frame(region, R2 = r2_squared)
    write.table(df, paste0("ABCD.", names(data_files[i]), ".GlbSA.txt"), sep = "\t", row.names = F, col.names = T)
  }
}

# Reg.CT ~ fPGS + Glb.CT (macro-structure)
for (i in 6) {
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for(j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    IMG.model = lm(currentROI ~ Age + Age_squared + CT +
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    region[j] = reg.list[j]
    r2_squared[j] = summary(IMG.model)$adj.r.squared
    df= data.frame(region, R2 = r2_squared)
    write.table(df, paste0("ABCD.", names(data_files[i]), ".GlbCT.txt"), sep = "\t", row.names = F, col.names = T)
  }
}

# Reg.MC ~ fPGS + Glb.MC (macro-structure)
for (i in 7) {
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for(j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    IMG.model = lm(currentROI ~ Age + Age_squared + meanCurv +
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    region[j] = reg.list[j]
    r2_squared[j] = summary(IMG.model)$adj.r.squared
    df= data.frame(region, R2 = r2_squared)
    write.table(df, paste0("ABCD.", names(data_files[i]), ".GlbMC.txt"), sep = "\t", row.names = F, col.names = T)
  }
}

# For Reg.ICVF~ fPGS + Glb.ICVF (micro-structure)
for (i in 8) {
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for (j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    IMG.model = lm(currentROI ~ Age + Age_squared + NODDI_ICVF +
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    region[j] = reg.list[j]
    r2_squared[j] = summary(IMG.model)$adj.r.squared
    df= data.frame(region, R2 = r2_squared)
    write.table(df, paste0("ABCD.", names(data_files[i]), ".GlbICVF.txt"), sep = "\t", row.names = F, col.names = T)
  }
}



# For male populations
# Reg.SA ~ mPGS + Glb.SA (macro-structure)
for (i in 9) {
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for(j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    IMG.model = lm(currentROI ~ Age + Age_squared + SA +
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    region[j] = reg.list[j]
    r2_squared[j] = summary(IMG.model)$adj.r.squared
    df= data.frame(region, R2 = r2_squared)
    write.table(df, paste0("ABCD.", names(data_files[i]), ".GlbSA.txt"), sep = "\t", row.names = F, col.names = T)
  }
}

# Reg.CT ~ mPGS + Glb.CT (macro-structure)
for (i in 10) {
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for(j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    IMG.model = lm(currentROI ~ Age + Age_squared + CT +
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    region[j] = reg.list[j]
    r2_squared[j] = summary(IMG.model)$adj.r.squared
    df= data.frame(region, R2 = r2_squared)
    write.table(df, paste0("ABCD.", names(data_files[i]), ".GlbCT.txt"), sep = "\t", row.names = F, col.names = T)
  }
}

# Reg.MC ~ mPGS + Glb.MC (macro-structure)
for (i in 11) {
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for(j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    IMG.model = lm(currentROI ~ Age + Age_squared + meanCurv +
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    region[j] = reg.list[j]
    r2_squared[j] = summary(IMG.model)$adj.r.squared
    df= data.frame(region, R2 = r2_squared)
    write.table(df, paste0("ABCD.", names(data_files[i]), ".GlbMC.txt"), sep = "\t", row.names = F, col.names = T)
  }
}

# For Reg.ICVF~ mPGS + Glb.ICVF (micro-structure)
for (i in 12) {
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for (j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    IMG.model = lm(currentROI ~ Age + Age_squared + NODDI_ICVF +
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    region[j] = reg.list[j]
    r2_squared[j] = summary(IMG.model)$adj.r.squared
    df= data.frame(region, R2 = r2_squared)
    write.table(df, paste0("ABCD.", names(data_files[i]), ".GlbICVF.txt"), sep = "\t", row.names = F, col.names = T)
  }
}

```

```{r lm model loop for Reg.IMG~Sex:PGS + Glb.IMG+COVAR for Inc.R2 PGS calculation, eval=FALSE, include=FALSE}

# For Reg.SA~Sex:PGS + Glb.SA (macro-structure)
for (i in 1) {
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for (j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    IMG.model = lm(currentROI ~ SA + Sex + Age + Age_squared + Sex * Age + Sex * Age_squared + PGS * Sex +
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    region[j] = reg.list[j]
    r2_squared[j] = summary(IMG.model)$adj.r.squared
    df= data.frame(region, R2 = r2_squared)
    write.table(df, paste0("ABCD.", names(data_files[i]), ".GlbSA_SEX.txt"), sep = "\t", row.names = F, col.names = T)
  }
}


# For Reg.CT~Sex:PGS + Glb.CT (macro-structure)
for (i in 2) {
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for (j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    IMG.model = lm(currentROI ~ CT + Sex + Age + Age_squared + Sex * Age + Sex * Age_squared + PGS * Sex +
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    region[j] = reg.list[j]
    r2_squared[j] = summary(IMG.model)$adj.r.squared
    df= data.frame(region, R2 = r2_squared)
    write.table(df, paste0("ABCD.", names(data_files[i]), ".GlbCT_SEX.txt"), sep = "\t", row.names = F, col.names = T)
  }
}


# For Reg.MC~PGS + Sex:PGS + Glb.MC (macro-structure)
for (i in 3) {
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for (j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    IMG.model = lm(currentROI ~ meanCurv + Sex + Age + Age_squared + Sex * Age + Sex * Age_squared + PGS * Sex +
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    region[j] = reg.list[j]
    r2_squared[j] = summary(IMG.model)$adj.r.squared
    df= data.frame(region, R2 = r2_squared)
    write.table(df, paste0("ABCD.", names(data_files[i]), ".GlbMC_SEX.txt"), sep = "\t", row.names = F, col.names = T)
  }
}

# For Reg.IMG~PGS + Sex:PGS + Glb.ICVF (micro-structure)
for (i in 4) {
  r2_squared = matrix(NA, nrow = n_regions)
  region = matrix(NA, nrow = n_regions)
  for (j in 1:n_regions) {
    setwd(here("Results/ABCD/"))
    temp.data <- data_files[[i]]
    reg.list <- colnames(temp.data)[29:208] # list of regions
    currentROI <- temp.data[,which(names(temp.data)==reg.list[j])]
    temp.data = cbind(temp.data, currentROI)
    print(paste("working on:", names(data_files[i]), "column", reg.list[j]))
    IMG.model = lm(currentROI ~ NODDI_ICVF + Sex + Age + Age_squared + Sex * Age + Sex * Age_squared + PGS * Sex +
                        gPC1 + gPC2 + gPC3 + gPC4 + gPC5 + gPC6 + gPC7 + gPC8 + gPC9 + gPC10 + 
                        site_id_l + leftplusright + fd_1, data = temp.data)
    region[j] = reg.list[j]
    r2_squared[j] = summary(IMG.model)$adj.r.squared
    df= data.frame(region, R2 = r2_squared)
    write.table(df, paste0("ABCD.", names(data_files[i]), ".GlbICVF_SEX.txt"), sep = "\t", row.names = F, col.names = T)
  }
}

```


# Regional Inc.R2 Calculation and visualisation
```{r read-in regional generated data for generating Inc.R2}
# For loop to read in all with PGS and without PGS/fPGS/mPGS/PGS:SEX models
R2.reg.list <- paste0(here("Results/ABCD/", list.files(path = here("Results/ABCD/"), pattern = "*.txt"))) # Grab file directories

for (i in 1:length(R2.reg.list)) {
  df = fread(R2.reg.list[i])
  df_name = sub("C:/Users/yg330/OneDrive - University of Cambridge/Documents/Projects/pgs_img/Results/ABCD//", "" , R2.reg.list[i])
  df_name = sub(".txt", "", df_name)
  assign(df_name, df)
}
```

```{r Calculating Inc.R2 for PGS and PGS:SEX lm models}

# Format for Reg.IMG~PGS:
# ABCD.PGS.reg.pgs.SA_v2
# ABCD.PGS.reg.pgs.CT_v2
# ABCD.PGS.reg.pgs.MC_v2
# ABCD.PGS.reg.pgs.ICVF_v2


# Format for Reg.IMG~COVAR
# ABCD.reg.pgs.SA_v2
# ABCD.reg.pgs.CT_v2
# ABCD.reg.pgs.MC_v2
# ABCD.reg.pgs.ICVF_v2

# For Reg.IMG~PGS
ABCD.PGS.reg.pgs.SA_v2$Inc.R2 <- ABCD.PGS.reg.pgs.SA_v2$R2 - ABCD.reg.pgs.SA_v2$R2
ABCD.PGS.reg.pgs.CT_v2$Inc.R2 <- ABCD.PGS.reg.pgs.CT_v2$R2 - ABCD.reg.pgs.CT_v2$R2
ABCD.PGS.reg.pgs.MC_v2$Inc.R2 <- ABCD.PGS.reg.pgs.MC_v2$R2 - ABCD.reg.pgs.MC_v2$R2
ABCD.PGS.reg.pgs.ICVF_v2$Inc.R2 <- ABCD.PGS.reg.pgs.ICVF_v2$R2 - ABCD.reg.pgs.ICVF_v2$R2

summary(ABCD.PGS.reg.pgs.SA_v2$Inc.R2)
vis.IncR2.SA <- ggplot(ABCD.PGS.reg.pgs.SA_v2, aes(x=region, y=Inc.R2)) + geom_bar(stat="identity") + ylim(-0.001, 0.001)
vis.IncR2.SA

summary(ABCD.PGS.reg.pgs.CT_v2$Inc.R2)
vis.IncR2.CT <- ggplot(ABCD.PGS.reg.pgs.CT_v2, aes(x=region, y=Inc.R2)) + geom_bar(stat="identity") + ylim(-0.001, 0.001)
vis.IncR2.CT

summary(ABCD.PGS.reg.pgs.MC_v2$Inc.R2)
vis.IncR2.MC <- ggplot(ABCD.PGS.reg.pgs.MC_v2, aes(x=region, y=Inc.R2)) + geom_bar(stat="identity") + ylim(-0.001, 0.001)
vis.IncR2.MC

summary(ABCD.PGS.reg.pgs.ICVF_v2$Inc.R2)
vis.IncR2.ICVF <- ggplot(ABCD.PGS.reg.pgs.ICVF_v2, aes(x=region, y=Inc.R2)) + geom_bar(stat="identity") + ylim(-0.001, 0.001)
vis.IncR2.ICVF


# For Reg.IMG~PGS + Glb.IMG
# ABCD.PGS.reg.pgs.SA.GlbSA_v2
# ABCD.PGS.reg.pgs.CT.GlbCT_v2
# ABCD.PGS.reg.pgs.MC.GlbMC_v2
# ABCD.PGS.reg.pgs.ICVF.GlbICVF_v2


# Reg.IMG~Glb.IMG+COVAR
# ABCD.reg.pgs.SA.GlbSA
# ABCD.reg.pgs.CT.GlbCT
# ABCD.reg.pgs.MC.GlbMC # Typo become ABCDreg.pgs.MC.GlbMC
# ABCD.reg.pgs.ICVF.GlbICVF

# For Reg.IMG~PGS+Glb.IMG - Reg.IMG~Glb.IMG
ABCD.PGS.reg.pgs.SA.GlbSA_v2$Inc.R2 <- ABCD.PGS.reg.pgs.SA.GlbSA_v2$R2 - ABCD.reg.pgs.SA.GlbSA$R2
ABCD.PGS.reg.pgs.CT.GlbCT_v2$Inc.R2 <- ABCD.PGS.reg.pgs.CT.GlbCT_v2$R2 - ABCD.reg.pgs.CT.GlbCT$R2
ABCD.PGS.reg.pgs.MC.GlbMC_v2$Inc.R2 <- ABCD.PGS.reg.pgs.MC.GlbMC_v2$R2 - ABCDreg.pgs.MC.GlbMC$R2
ABCD.PGS.reg.pgs.ICVF.GlbICVF_v2$Inc.R2 <- ABCD.PGS.reg.pgs.ICVF.GlbICVF_v2$R2 - ABCD.reg.pgs.ICVF.GlbICVF$R2

summary(ABCD.PGS.reg.pgs.SA.GlbSA_v2$Inc.R2)
vis.IncR2.SA.Glb <- ggplot(ABCD.PGS.reg.pgs.SA.GlbSA_v2, aes(x=region, y=Inc.R2)) + geom_bar(stat="identity") + ylim(-0.001, 0.001)
vis.IncR2.SA.Glb

summary(ABCD.PGS.reg.pgs.CT.GlbCT_v2$Inc.R2)
vis.IncR2.CT.Glb <- ggplot(ABCD.PGS.reg.pgs.CT.GlbCT_v2, aes(x=region, y=Inc.R2)) + geom_bar(stat="identity") + ylim(-0.001, 0.001)
vis.IncR2.CT.Glb

summary(ABCD.PGS.reg.pgs.MC.GlbMC_v2$Inc.R2)
vis.IncR2.MC.Glb <- ggplot(ABCD.PGS.reg.pgs.MC.GlbMC_v2, aes(x=region, y=Inc.R2)) + geom_bar(stat="identity") + ylim(-0.001, 0.001)
vis.IncR2.MC.Glb

summary(ABCD.PGS.reg.pgs.ICVF.GlbICVF_v2$Inc.R2)
vis.IncR2.ICVF.Glb <- ggplot(ABCD.PGS.reg.pgs.ICVF.GlbICVF_v2, aes(x=region, y=Inc.R2)) + geom_bar(stat="identity") + ylim(-0.001, 0.001)
vis.IncR2.ICVF.Glb


# For f/m Reg.IMG ~ fPGS/mPGS + Glb.IMG 
# ABCD.PGS.f.reg.pgs.SA.GlbSA_V2
# ABCD.PGS.f.reg.pgs.CT.GlbCT_V2
# ABCD.PGS.f.reg.pgs.MC.GlbMC_V2
# ABCD.PGS.f.reg.pgs.ICVF.GlbICVF_V2
# same logic for male population


# f/m Reg.IMG ~ f/m Glb.IMG+COVAR
# ABCD.f.reg.pgs.SA.GlbSA
# ABCD.f.reg.pgs.CT.GlbCT
# ABCD.f.reg.pgs.MC.GlbMC
# ABCD.f.reg.pgs.ICVF.GlbICVF
# same logic for male population

# For fReg.IMG~fPGS+fGlb.IMG - fReg.IMG~fGlb.IMG
ABCD.PGS.f.reg.pgs.SA.GlbSA_V2$Inc.R2 <- ABCD.PGS.f.reg.pgs.SA.GlbSA_V2$R2 - ABCD.f.reg.pgs.SA.GlbSA$R2
ABCD.PGS.f.reg.pgs.CT.GlbCT_v2$Inc.R2 <- ABCD.PGS.f.reg.pgs.CT.GlbCT_v2$R2 - ABCD.f.reg.pgs.CT.GlbCT$R2
ABCD.PGS.f.reg.pgs.MC.GlbMC_v2$Inc.R2 <- ABCD.PGS.f.reg.pgs.MC.GlbMC_v2$R2 - ABCD.f.reg.pgs.MC.GlbMC$R2
ABCD.PGS.f.reg.pgs.ICVF.GlbICVF_v2$Inc.R2 <- ABCD.PGS.f.reg.pgs.ICVF.GlbICVF_v2$R2 - ABCD.f.reg.pgs.ICVF.GlbICVF$R2

summary(ABCD.PGS.f.reg.pgs.SA.GlbSA_V2$Inc.R2)
f.vis.IncR2.SA.Glb <- ggplot(ABCD.PGS.f.reg.pgs.SA.GlbSA_V2, aes(x=region, y=Inc.R2)) + geom_bar(stat="identity") + ylim(-0.001, 0.001)
f.vis.IncR2.SA.Glb

summary(ABCD.PGS.f.reg.pgs.CT.GlbCT_v2$Inc.R2)
f.vis.IncR2.CT.Glb <- ggplot(ABCD.PGS.f.reg.pgs.CT.GlbCT_v2, aes(x=region, y=Inc.R2)) + geom_bar(stat="identity") + ylim(-0.001, 0.001)
f.vis.IncR2.CT.Glb

summary(ABCD.PGS.f.reg.pgs.MC.GlbMC_v2$Inc.R2)
f.vis.IncR2.MC.Glb <- ggplot(ABCD.PGS.f.reg.pgs.MC.GlbMC_v2, aes(x=region, y=Inc.R2)) + geom_bar(stat="identity") + ylim(-0.001, 0.001)
f.vis.IncR2.MC.Glb

summary(ABCD.PGS.f.reg.pgs.ICVF.GlbICVF_v2$Inc.R2)
f.vis.IncR2.ICVF.Glb <- ggplot(ABCD.PGS.f.reg.pgs.ICVF.GlbICVF_v2, aes(x=region, y=Inc.R2)) + geom_bar(stat="identity") + ylim(-0.001, 0.001)
f.vis.IncR2.ICVF.Glb

# For mReg.IMG~mPGS+mGlb.IMG
ABCD.PGS.m.reg.pgs.SA.GlbSA_v2$Inc.R2 <- ABCD.PGS.m.reg.pgs.SA.GlbSA_v2$R2 - ABCD.m.reg.pgs.SA.GlbSA$R2
ABCD.PGS.m.reg.pgs.CT.GlbCT_v2$Inc.R2 <- ABCD.PGS.m.reg.pgs.CT.GlbCT_v2$R2 - ABCD.m.reg.pgs.CT.GlbCT$R2
ABCD.PGS.m.reg.pgs.MC.GlbMC_v2$Inc.R2 <- ABCD.PGS.m.reg.pgs.MC.GlbMC_v2$R2 - ABCD.m.reg.pgs.MC.GlbMC$R2
ABCD.PGS.m.reg.pgs.ICVF.GlbICVF_v2$Inc.R2 <- ABCD.PGS.m.reg.pgs.ICVF.GlbICVF_v2$R2 - ABCD.m.reg.pgs.ICVF.GlbICVF$R2

summary(ABCD.PGS.m.reg.pgs.SA.GlbSA_v2$Inc.R2)
m.vis.IncR2.SA.Glb <- ggplot(ABCD.PGS.m.reg.pgs.SA.GlbSA_v2, aes(x=region, y=Inc.R2)) + geom_bar(stat="identity") + ylim(-0.001, 0.001)
m.vis.IncR2.SA.Glb

summary(ABCD.PGS.m.reg.pgs.CT.GlbCT_v2$Inc.R2)
m.vis.IncR2.CT.Glb <- ggplot(ABCD.PGS.m.reg.pgs.CT.GlbCT_v2, aes(x=region, y=Inc.R2)) + geom_bar(stat="identity") + ylim(-0.001, 0.001)
m.vis.IncR2.CT.Glb

summary(ABCD.PGS.m.reg.pgs.MC.GlbMC_v2$Inc.R2)
m.vis.IncR2.MC.Glb <- ggplot(ABCD.PGS.m.reg.pgs.MC.GlbMC_v2, aes(x=region, y=Inc.R2)) + geom_bar(stat="identity") + ylim(-0.001, 0.001)
m.vis.IncR2.MC.Glb

summary(ABCD.PGS.m.reg.pgs.ICVF.GlbICVF_v2$Inc.R2)
m.vis.IncR2.ICVF.Glb <- ggplot(ABCD.PGS.m.reg.pgs.ICVF.GlbICVF_v2, aes(x=region, y=Inc.R2)) + geom_bar(stat="identity") + ylim(-0.001, 0.001)
m.vis.IncR2.ICVF.Glb


# For Reg.IMG~PGS + Sex:PGS + Glb.IMG
# ABCD.PGS.reg.pgs.SA.GlbSA_v2_SEX
# ABCD.PGS.reg.pgs.CT.GlbCT_v2_SEX
# ABCD.PGS.reg.pgs.MC.GlbMC_v2_SEX
# ABCD.PGS.reg.pgs.ICVF.GlbICVF_v2_SEX

# For Reg.IMG~PGS:SEX+ Glb.IMG + COVAR
# ABCD.reg.pgs.SA.GlbSA_SEX
# ABCD.reg.pgs.CT.GlbCT_SEX
# ABCD.reg.pgs.MC.GlbMC_SEX
# ABCD.reg.pgs.ICVF.GlbICVF_SEX

# For PGS:SEX
ABCD.PGS.reg.pgs.SA.GlbSA_v2_SEX$Inc.R2.SEX <- ABCD.PGS.reg.pgs.SA.GlbSA_v2_SEX$R2 - ABCD.reg.pgs.SA.GlbSA_SEX$R2
ABCD.PGS.reg.pgs.CT.GlbCT_v2_SEX$Inc.R2.SEX <- ABCD.PGS.reg.pgs.CT.GlbCT_v2_SEX$R2 - ABCD.reg.pgs.CT.GlbCT_SEX$R2
ABCD.PGS.reg.pgs.MC.GlbMC_v2_SEX$Inc.R2.SEX <- ABCD.PGS.reg.pgs.MC.GlbMC_v2_SEX$R2 - ABCD.reg.pgs.MC.GlbMC_SEX$R2
ABCD.PGS.reg.pgs.ICVF.GlbICVF_v2_SEX$Inc.R2.SEX <- ABCD.PGS.reg.pgs.ICVF.GlbICVF_v2_SEX$R2 - ABCD.reg.pgs.ICVF.GlbICVF_SEX$R2

summary(ABCD.PGS.reg.pgs.SA.GlbSA_v2_SEX$Inc.R2.SEX)
vis.IncR2.SA.Glb.SEXPGS <- ggplot(ABCD.PGS.reg.pgs.SA.GlbSA_v2_SEX, aes(x=region, y=Inc.R2.SEX)) + geom_bar(stat="identity") + ylim(-0.001, 0.001)
vis.IncR2.SA.Glb.SEXPGS

summary(ABCD.PGS.reg.pgs.CT.GlbCT_v2_SEX$Inc.R2.SEX)
vis.IncR2.CT.Glb.SEXPGS <- ggplot(ABCD.PGS.reg.pgs.CT.GlbCT_v2_SEX, aes(x=region, y=Inc.R2.SEX)) + geom_bar(stat="identity") + ylim(-0.001, 0.001)
vis.IncR2.CT.Glb.SEXPGS

summary(ABCD.PGS.reg.pgs.MC.GlbMC_v2_SEX$Inc.R2.SEX)
vis.IncR2.MC.Glb.SEXPGS <- ggplot(ABCD.PGS.reg.pgs.MC.GlbMC_v2_SEX, aes(x=region, y=Inc.R2.SEX)) + geom_bar(stat="identity") + ylim(-0.001, 0.001)
vis.IncR2.MC.Glb.SEXPGS

summary(ABCD.PGS.reg.pgs.ICVF.GlbICVF_v2_SEX$Inc.R2.SEX)
vis.IncR2.ICVF.Glb.SEXPGS <- ggplot(ABCD.PGS.reg.pgs.ICVF.GlbICVF_v2_SEX, aes(x=region, y=Inc.R2.SEX)) + geom_bar(stat="identity") + ylim(-0.001, 0.001)
vis.IncR2.ICVF.Glb.SEXPGS


# For Reg.IMG~PGS + Sex:PGS + Glb.IMG
# ABCD.PGS.reg.pgs.SA.GlbSA_v2_SEX
# ABCD.PGS.reg.pgs.CT.GlbCT_v2_SEX
# ABCD.PGS.reg.pgs.MC.GlbMC_v2_SEX
# ABCD.PGS.reg.pgs.ICVF.GlbICVF_v2_SEX

# For Reg.IMG~PGS + Glb.IMG
# ABCD.PGS.reg.pgs.SA.GlbSA_v2
# ABCD.PGS.reg.pgs.CT.GlbCT_v2
# ABCD.PGS.reg.pgs.MC.GlbMC_v2
# ABCD.PGS.reg.pgs.ICVF.GlbICVF_v2


# For PGS
ABCD.PGS.reg.pgs.SA.GlbSA_v2_SEX$Inc.R2 <- ABCD.PGS.reg.pgs.SA.GlbSA_v2_SEX$R2 - ABCD.PGS.reg.pgs.SA.GlbSA_v2$R2
ABCD.PGS.reg.pgs.CT.GlbCT_v2_SEX$Inc.R2 <- ABCD.PGS.reg.pgs.CT.GlbCT_v2_SEX$R2 - ABCD.PGS.reg.pgs.CT.GlbCT_v2$R2
ABCD.PGS.reg.pgs.MC.GlbMC_v2_SEX$Inc.R2 <- ABCD.PGS.reg.pgs.MC.GlbMC_v2_SEX$R2 - ABCD.PGS.reg.pgs.MC.GlbMC_v2$R2
ABCD.PGS.reg.pgs.ICVF.GlbICVF_v2_SEX$Inc.R2 <- ABCD.PGS.reg.pgs.ICVF.GlbICVF_v2_SEX$R2 - ABCD.PGS.reg.pgs.ICVF.GlbICVF_v2$R2

summary(ABCD.PGS.reg.pgs.SA.GlbSA_v2_SEX$Inc.R2)
vis.IncR2.SA.Glb.SEX <- ggplot(ABCD.PGS.reg.pgs.SA.GlbSA_v2_SEX, aes(x=region, y=Inc.R2)) + geom_bar(stat="identity")
vis.IncR2.SA.Glb.SEX

summary(ABCD.PGS.reg.pgs.CT.GlbCT_v2_SEX$Inc.R2)
vis.IncR2.CT.Glb.SEX <- ggplot(ABCD.PGS.reg.pgs.CT.GlbCT_v2_SEX, aes(x=region, y=Inc.R2)) + geom_bar(stat="identity")
vis.IncR2.CT.Glb.SEX

summary(ABCD.PGS.reg.pgs.MC.GlbMC_v2_SEX$Inc.R2)
vis.IncR2.MC.Glb.SEX <- ggplot(ABCD.PGS.reg.pgs.MC.GlbMC_v2_SEX, aes(x=region, y=Inc.R2)) + geom_bar(stat="identity")
vis.IncR2.MC.Glb.SEX

summary(ABCD.PGS.reg.pgs.ICVF.GlbICVF_v2_SEX$Inc.R2)
vis.IncR2.ICVF.Glb.SEX <- ggplot(ABCD.PGS.reg.pgs.ICVF.GlbICVF_v2_SEX, aes(x=region, y=Inc.R2)) + geom_bar(stat="identity")
vis.IncR2.ICVF.Glb.SEX

```

# Regional Data Visualisation
```{r visualisation dataframe preperation}
# create a list of dataframe to add label for regional brain visualization
vis.reg.list <- R2.reg.list
vis.reg.list <- gsub("C:/Users/yg330/OneDrive - University of Cambridge/Documents/Projects/pgs_img/Results/ABCD//", "" , vis.reg.list)
vis.reg.list <- gsub(".txt", "", vis.reg.list)
vis.reg.list <- str_subset(vis.reg.list, ".PGS.") # Remove datasets with no PGS coefficient in its lm model

vis.df = lapply(vis.reg.list, get) # Create list of data sets
names(vis.df) = vis.reg.list # Assign name for the list of data sets for looping

vis.df.SEX <- c(vis.df[grep("SEX", vis.df)])
vis.df <- vis.df[grepl("SEX", vis.df) == "FALSE"]

# For and ifelse loop to format region names to Glasser standard and to add additional labels on every data sets at once

for (i in 1:length(vis.df)) {
  print(paste0("Currently working on ", names(vis.df[i])))
  vis.df[[i]]$region <- gsub("X","",as.character(vis.df[[i]]$region)) # Remove X to fit format
  vis.df[[i]]$region <- gsub("\\.","-",as.character(vis.df[[i]]$region)) # Replace . as - to fit format
  vis.df[[i]]$p_adj <- p.adjust(vis.df[[i]]$P_val, method = "fdr", n = 180) # multiple testing correction, as we only got 180 rows as regions, doesn't need to specify 180 for the correction.
  vis.df[[i]]$Sig.adj.P <- ifelse(vis.df[[i]]$p_adj <= 0.05, "Sig", "Not Sig") # significance label
  if(grepl("SA", names(vis.df[i]))){
    print("Dataset title has SA, adding labels")
    vis.df[[i]] <- vis.df[[i]] %>% mutate(Label = "Surface Area")
    vis.df[[i]] <- vis.df[[i]] %>% mutate(Class = "Macrostructure")
  } else if (grepl("CT", names(vis.df[i]))) {
    print("Dataset title has CT, adding labels")
    vis.df[[i]] <- vis.df[[i]] %>% mutate(Label = "Cortical Thickness")
    vis.df[[i]] <- vis.df[[i]] %>% mutate(Class = "Macrostructure")
  } else if (grepl("MC", names(vis.df[i]))) {
    print("Dataset title has MC, adding labels")
    vis.df[[i]] <- vis.df[[i]] %>% mutate(Label = "Mean Curvature")
    vis.df[[i]] <- vis.df[[i]] %>% mutate(Class = "Macrostructure")
  } else if (grepl("ICVF", names(vis.df[i]))) {
    print("Dataset title has ICVF, adding labels")
    vis.df[[i]] <- vis.df[[i]] %>% mutate(Label = "Intracellular Volume Fraction")
    vis.df[[i]] <- vis.df[[i]] %>% mutate(Class = "Microstructure")
  } else {
    print("Error, couldn't find target phenotype, check dataframe name")
  }
}

# For PGS:SEX Model, getting p_val for both PGS and PGS:SEX
for (i in 1:length(vis.df.SEX)) {
  print(paste0("Currently working on ", names(vis.df.SEX[i])))
  vis.df.SEX[[i]]$region <- gsub("X","",as.character(vis.df.SEX[[i]]$region)) # Remove X to fit format
  vis.df.SEX[[i]]$region <- gsub("\\.","-",as.character(vis.df.SEX[[i]]$region)) # Replace . as - to fit format
  
  vis.df.SEX[[i]]$PGS.p_adj <- p.adjust(vis.df.SEX[[i]]$PGS_P_val, method = "fdr", n = 180) # multiple testing correction, as we only got 180 rows as regions, doesn't need to specify 180 for the correction.
  vis.df.SEX[[i]]$PGS.Sig.adj.P <- ifelse(vis.df.SEX[[i]]$PGS.p_adj <= 0.05, "Sig", "Not Sig") # significance label
  
  vis.df.SEX[[i]]$PGS.SEX.p_adj <- p.adjust(vis.df.SEX[[i]]$PGS_SEX_P_val, method = "fdr", n=180)
  vis.df.SEX[[i]]$PGS.SEX.Sig.adj.P <- ifelse(vis.df.SEX[[i]]$PGS.SEX.p_adj <= 0.05, "Sig", "Not Sig") 
    if(grepl("SA", names(vis.df.SEX[i]))){
    print("Dataset title has SA, adding labels")
    vis.df.SEX[[i]] <- vis.df.SEX[[i]] %>% mutate(Label = "Surface Area")
    vis.df.SEX[[i]] <- vis.df.SEX[[i]] %>% mutate(Class = "Macrostructure")
  } else if (grepl("CT", names(vis.df.SEX[i]))) {
    print("Dataset title has CT, adding labels")
    vis.df.SEX[[i]] <- vis.df.SEX[[i]] %>% mutate(Label = "Cortical Thickness")
    vis.df.SEX[[i]] <- vis.df.SEX[[i]] %>% mutate(Class = "Macrostructure")
  } else if (grepl("MC", names(vis.df.SEX[i]))) {
    print("Dataset title has MC, adding labels")
    vis.df.SEX[[i]] <- vis.df.SEX[[i]] %>% mutate(Label = "Mean Curvature")
    vis.df.SEX[[i]] <- vis.df.SEX[[i]] %>% mutate(Class = "Macrostructure")
  } else if (grepl("ICVF", names(vis.df.SEX[i]))) {
    print("Dataset title has ICVF, adding labels")
    vis.df.SEX[[i]] <- vis.df.SEX[[i]] %>% mutate(Label = "Intracellular Volume Fraction")
    vis.df.SEX[[i]] <- vis.df.SEX[[i]] %>% mutate(Class = "Microstructure")
  } else {
    print("Error, couldn't find target phenotype, check dataframe name")
  }
}

# Generate Master Tables
master.f.reg.vis <- c(vis.df[1:4]) # manual checked for correctness
master.m.reg.vis <- c(vis.df[5:8])
master.reg.vis.glb <- c(vis.df[c(9,11,13,15)])
master.reg.vis <- c(vis.df[c(10,12,14,16)])

master.f.reg.vis <- master.f.reg.vis %>% reduce(full_join)
master.m.reg.vis <- master.m.reg.vis %>% reduce(full_join)
master.reg.vis <- master.reg.vis %>% reduce(full_join)
master.reg.vis.glb <- master.reg.vis.glb %>% reduce(full_join)
master.reg.vis.glb.Sex <- vis.df.SEX %>% reduce(full_join)

```

```{r Visualisation for Reg.IMG~PGS, Reg.IMG~PGS+Glb.IMG, Reg.IMG~PGS:SEX, fReg.IMG~fPGS+fGlb.IMG, mReg.IMG~mPGS+mGlb.IMG}

print(master.reg.vis[master.reg.vis$Sig.adj.P == "Sig"])
print(master.reg.vis.glb[master.reg.vis.glb$Sig.adj.P == "Sig"])

print(master.reg.vis.glb.Sex[master.reg.vis.glb.Sex$PGS.Sig.adj.P == "Sig"])
print(master.reg.vis.glb.Sex[master.reg.vis.glb.Sex$PGS.SEX.Sig.adj.P == "Sig"])

print(master.f.reg.vis[master.f.reg.vis$Sig.adj.P == "Sig"])
print(master.m.reg.vis[master.m.reg.vis$Sig.adj.P == "Sig"])

sig.list.excel.export <- list("Eqn2" = data.frame(master.reg.vis[master.reg.vis$Sig.adj.P == "Sig"]), 
                              "Eqn3" = data.frame(master.reg.vis.glb[master.reg.vis.glb$Sig.adj.P == "Sig"]), 
                              "Eqn5A" = data.frame(master.reg.vis.glb.Sex[master.reg.vis.glb.Sex$PGS.Sig.adj.P == "Sig"]),
                              "Eqn5B" = data.frame(master.reg.vis.glb.Sex[master.reg.vis.glb.Sex$PGS.SEX.Sig.adj.P == "Sig"]))
write.xlsx(sig.list.excel.export, file = here("Report/Sig_regions_ABCD.xlsx")) 

# For Reg.IMG~PGS
reg.vis <- master.reg.vis %>% group_by(Label) %>% 
  ggseg(mapping=aes(fill=(Beta_Estimates), col = Sig.adj.P), atlas = "glasser", 
        hemisphere = "right", position="stacked", size= 0.1) +
  scale_fill_gradient2(low = "blue", mid="white",high="orange") +
  scale_colour_manual(values=c("lightgrey", "red")) +
  facet_wrap(~Label) + theme_minimal() + labs(fill = "PGS Beta Estimates") +
  theme(legend.position = "right", axis.title.x = element_blank(), 
        axis.title.y = element_blank(), axis.text.y = element_blank(),
        strip.text.x = element_text(size = 14)) +
  ggtitle("Equation 2: Reg.IMG~PGS+Covar", subtitle = "based on PGS p_val")
reg.vis + guides(col = FALSE)

# For Reg.IMG~PGS+Glb.IMG
reg.vis.glb <- master.reg.vis.glb %>% group_by(Label) %>% 
  ggseg(mapping=aes(fill=(Beta_Estimates), col = Sig.adj.P), atlas = "glasser", 
        hemisphere = "right", position="stacked", size= 0.1) +
  scale_fill_gradient2(low = "blue", mid="white",high="orange") +
  scale_colour_manual(values=c("lightgrey", "red")) +
  facet_wrap(~Label) + theme_minimal() + labs(fill = "PGS Beta Estimates") +
  theme(legend.position = "right", axis.title.x = element_blank(), 
        axis.title.y = element_blank(), axis.text.y = element_blank(),
        strip.text.x = element_text(size = 14)) +
  ggtitle("Equation 3: Reg.IMG~PGS+Glb.IMG+Covar", subtitle = "based on PGS p_val")
reg.vis.glb + guides(col = FALSE)

# For Reg.IMG~PGS:SEX
reg.vis.glb.Sex <- master.reg.vis.glb.Sex %>% group_by(Label) %>% 
  ggseg(mapping=aes(fill=(PGS_Beta_Estimates), col = PGS.Sig.adj.P), atlas = "glasser", 
        hemisphere = "right", position="stacked", size= 0.1) +
  scale_fill_gradient2(low = "blue", mid="white",high="orange") +
  scale_colour_manual(values=c("lightgrey", "red")) +
  facet_wrap(~Label) + theme_minimal() + labs(fill = "PGS Beta Estimates") +
  theme(legend.position = "right", axis.title.x = element_blank(), 
        axis.title.y = element_blank(), axis.text.y = element_blank(),
        strip.text.x = element_text(size = 14)) +
  ggtitle("Equation 5: Reg.IMG~PGS+PGS:SEX+Glb.IMG+Covar", subtitle = "based on PGS p_val")
reg.vis.glb.Sex + guides(col = FALSE)

reg.vis.glb.Sex <- master.reg.vis.glb.Sex %>% group_by(Label) %>% 
  ggseg(mapping=aes(fill=(PGS_SEX_Beta_Estimates), col = PGS.SEX.Sig.adj.P), atlas = "glasser", 
        hemisphere = "right", position="stacked", size= 0.1) +
  scale_fill_gradient2(low = "blue", mid="white",high="orange") +
  scale_colour_manual(values=c("lightgrey", "red")) +
  facet_wrap(~Label) + theme_minimal() + labs(fill = "PGS:SEX Beta Estimates") +
  theme(legend.position = "right", axis.title.x = element_blank(), 
        axis.title.y = element_blank(), axis.text.y = element_blank(),
        strip.text.x = element_text(size = 14)) +
  ggtitle("Equation 5: Reg.IMG~PGS+PGS:SEX+Glb.IMG+Covar", subtitle = "based on PGS:SEX p_val")
reg.vis.glb.Sex + guides(col = FALSE)

# For fReg.IMG~fPGS+fGlb.IMG
f.reg.vis <- master.f.reg.vis %>% group_by(Label) %>% 
  ggseg(mapping=aes(fill=(Beta_Estimates), col = Sig.adj.P), atlas = "glasser", 
        hemisphere = "right", position="stacked", size= 0.1) +
  scale_fill_gradient2(low = "blue", mid="white",high="orange") +
  scale_colour_manual(values=c("lightgrey", "red")) +
  facet_wrap(~Label) + theme_minimal() + labs(fill = "PGS Beta Estimates") +
  theme(legend.position = "right", axis.title.x = element_blank(), 
        axis.title.y = element_blank(), axis.text.y = element_blank(),
        strip.text.x = element_text(size = 14)) +
  ggtitle("Equation 7: fReg.IMG~fPGS+fGlb.IMG+Covar", subtitle = "based on PGS p_val")
f.reg.vis + guides(col = FALSE)

# For mReg.IMG~mPGS+mGlb.IMG
m.reg.vis <- master.m.reg.vis %>% group_by(Label) %>% 
  ggseg(mapping=aes(fill=(Beta_Estimates), col = Sig.adj.P), atlas = "glasser", 
        hemisphere = "right", position="stacked", size= 0.1) +
  scale_fill_gradient2(low = "blue", mid="white",high="orange") +
  scale_colour_manual(values=c("lightgrey", "red")) +
  facet_wrap(~Label) + theme_minimal() + labs(fill = "PGS Beta Estimates") +
  theme(legend.position = "right", axis.title.x = element_blank(), 
        axis.title.y = element_blank(), axis.text.y = element_blank(),
        strip.text.x = element_text(size = 14)) +
  ggtitle("Equation 9: mReg.IMG~mPGS+mGlb.IMG+Covar", subtitle = "based on PGS p_val")
m.reg.vis + guides(col = FALSE)

```

```{r visualisation of significant results}
# For Reg.IMG~PGS
master.reg.vis.sig <- master.reg.vis[master.reg.vis$Label %in% c('Mean Curvature', 'Intracellular Volume Fraction'), ]
master.reg.vis.sig.sex <- master.reg.vis.glb.Sex[master.reg.vis.glb.Sex$Label == "Cortical Thickness"]

summary(master.reg.vis.sig$Inc.R2[master.reg.vis.sig$Sig.adj.P == "Sig" & master.reg.vis.sig$Label == "Intracellular Volume Fraction"]) # Inc.R2 range for ICVF

reg.vis.sig <- master.reg.vis.sig %>% group_by(Label) %>% 
  ggseg(mapping=aes(fill=(Beta_Estimates), col = Sig.adj.P), atlas = "glasser", 
        hemisphere = "right", position="stacked", size= 0.1) +
  scale_fill_gradient2(low = "blue", mid="white",high="orange") +
  scale_colour_manual(values=c("lightgrey", "red")) +
  facet_wrap(~Label) + theme_minimal() + labs(fill = "PGS Beta Estimates") +
  theme(legend.position = "right", axis.title.x = element_blank(), 
        axis.title.y = element_blank(), axis.text.y = element_blank(),
        strip.text.x = element_text(size = 14)) +
  ggtitle("Equation 2: Reg.IMG~PGS+Covar", subtitle = "based on PGS p_val")+ guides(col = FALSE)
reg.vis.sig 

reg.vis.glb.Sex <- master.reg.vis.sig.sex %>% group_by(Label) %>% 
  ggseg(mapping=aes(fill=(PGS_SEX_Beta_Estimates), col = PGS.SEX.Sig.adj.P), atlas = "glasser", 
        hemisphere = "right", position="stacked", size= 0.1) +
  scale_fill_gradient2(low = "blue", mid="white",high="orange") +
  scale_colour_manual(values=c("lightgrey", "red")) +
  facet_wrap(~Label) + theme_minimal() + labs(fill = "PGS:SEX Beta Estimates") +
  theme(legend.position = "right", axis.title.x = element_blank(), 
        axis.title.y = element_blank(), axis.text.y = element_blank(),
        strip.text.x = element_text(size = 14)) +
  ggtitle("Equation 5: Reg.IMG~PGS+PGS:SEX+Glb.IMG+Covar", subtitle = "based on PGS:SEX p_val")+ guides(col = FALSE)
reg.vis.glb.Sex 

```


# Regional Correlation Analysis between Sex by IMG Phenotypes
```{r Correlation between Unstratified male and females}
# Female and male were rescaled after sex stratification, therefore will not show inherent sex differences, but sex specific effect...
# PGS beta_estimates in f/m img~ f/m pgs + f/m Glb.img lm model
# For SA
SA.cor <- cor.test(master.f.reg.vis[Label == "Surface Area"]$Beta_Estimates, master.m.reg.vis[Label == "Surface Area"]$Beta_Estimates, method = "pearson")
SA.cor

# For CT
CT.cor <- cor.test(master.f.reg.vis[Label == "Cortical Thickness"]$Beta_Estimates, master.m.reg.vis[Label == "Cortical Thickness"]$Beta_Estimates, method = "pearson")
CT.cor

# For MC
MC.cor <- cor.test(master.f.reg.vis[Label == "Mean Curvature"]$Beta_Estimates, master.m.reg.vis[Label == "Mean Curvature"]$Beta_Estimates, method = "pearson")
MC.cor

# For ICVF
ICVF.cor <- cor.test(master.f.reg.vis[Label == "Intracellular Volume Fraction"]$Beta_Estimates, master.m.reg.vis[Label == "Intracellular Volume Fraction"]$Beta_Estimates, method = "pearson")
ICVF.cor
```